<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Mistra</title>
  
  <subtitle>ğŸ€ç¾Šç¾Šçš„ä¸‘æŸ‘å„¿ğŸ€</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://mistra.wang/"/>
  <updated>2019-05-05T02:40:05.392Z</updated>
  <id>http://mistra.wang/</id>
  
  <author>
    <name>ç‹ç‘</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>åŒæ­¥ã€å¼‚æ­¥ã€é˜»å¡ã€éé˜»å¡</title>
    <link href="http://mistra.wang/2019/05/05/%E5%90%8C%E6%AD%A5%E3%80%81%E5%BC%82%E6%AD%A5%E3%80%81%E9%98%BB%E5%A1%9E%E3%80%81%E9%9D%9E%E9%98%BB%E5%A1%9E/"/>
    <id>http://mistra.wang/2019/05/05/åŒæ­¥ã€å¼‚æ­¥ã€é˜»å¡ã€éé˜»å¡/</id>
    <published>2019-05-05T02:23:15.000Z</published>
    <updated>2019-05-05T02:40:05.392Z</updated>
    
    <content type="html"><![CDATA[<h3 id="åŒæ­¥å’Œå¼‚æ­¥å…³æ³¨çš„æ˜¯æ¶ˆæ¯é€šä¿¡æœºåˆ¶ï¼Œé’ˆå¯¹åº”ç”¨ç¨‹åºæ¥ï¼Œå…³æ³¨çš„æ˜¯ç¨‹åºä¸­é—´çš„åä½œå…³ç³»"><a href="#åŒæ­¥å’Œå¼‚æ­¥å…³æ³¨çš„æ˜¯æ¶ˆæ¯é€šä¿¡æœºåˆ¶ï¼Œé’ˆå¯¹åº”ç”¨ç¨‹åºæ¥ï¼Œå…³æ³¨çš„æ˜¯ç¨‹åºä¸­é—´çš„åä½œå…³ç³»" class="headerlink" title="åŒæ­¥å’Œå¼‚æ­¥å…³æ³¨çš„æ˜¯æ¶ˆæ¯é€šä¿¡æœºåˆ¶ï¼Œé’ˆå¯¹åº”ç”¨ç¨‹åºæ¥ï¼Œå…³æ³¨çš„æ˜¯ç¨‹åºä¸­é—´çš„åä½œå…³ç³»"></a>åŒæ­¥å’Œå¼‚æ­¥å…³æ³¨çš„æ˜¯æ¶ˆæ¯é€šä¿¡æœºåˆ¶ï¼Œé’ˆå¯¹åº”ç”¨ç¨‹åºæ¥ï¼Œå…³æ³¨çš„æ˜¯ç¨‹åºä¸­é—´çš„åä½œå…³ç³»</h3><ul><li>åŒæ­¥ï¼šæ‰§è¡Œä¸€ä¸ªæ“ä½œåï¼Œå¿…é¡»ç­‰å¾…è¿”å›ç»“æœï¼Œç„¶åæ‰ç»§ç»­æ‰§è¡Œåç»­çš„æ“ä½œ</li><li>å¼‚æ­¥ï¼šæ‰§è¡Œä¸€ä¸ªæ“ä½œåï¼Œä¸å¿…ç­‰å¾…è¿”å›ç»“æœï¼Œå¯ä»¥å»æ‰§è¡Œå…¶ä»–çš„æ“ä½œï¼Œç„¶åç­‰å¾…é€šçŸ¥å†å›æ¥æ‰§è¡Œåˆšæ‰æ²¡æ‰§è¡Œå®Œçš„æ“ä½œ(æ¯”å¦‚å›è°ƒå‡½æ•°é€šçŸ¥)</li></ul><h3 id="é˜»å¡å’Œéé˜»å¡å…³æ³¨çš„æ˜¯ç¨‹åºåœ¨ç­‰å¾…è°ƒç”¨ç»“æœæ—¶çš„çŠ¶æ€-CPUå±‚é¢-ï¼Œå•ä¸ªè¿›ç¨‹çš„æ‰§è¡ŒçŠ¶æ€"><a href="#é˜»å¡å’Œéé˜»å¡å…³æ³¨çš„æ˜¯ç¨‹åºåœ¨ç­‰å¾…è°ƒç”¨ç»“æœæ—¶çš„çŠ¶æ€-CPUå±‚é¢-ï¼Œå•ä¸ªè¿›ç¨‹çš„æ‰§è¡ŒçŠ¶æ€" class="headerlink" title="é˜»å¡å’Œéé˜»å¡å…³æ³¨çš„æ˜¯ç¨‹åºåœ¨ç­‰å¾…è°ƒç”¨ç»“æœæ—¶çš„çŠ¶æ€(CPUå±‚é¢)ï¼Œå•ä¸ªè¿›ç¨‹çš„æ‰§è¡ŒçŠ¶æ€"></a>é˜»å¡å’Œéé˜»å¡å…³æ³¨çš„æ˜¯ç¨‹åºåœ¨ç­‰å¾…è°ƒç”¨ç»“æœæ—¶çš„çŠ¶æ€(CPUå±‚é¢)ï¼Œå•ä¸ªè¿›ç¨‹çš„æ‰§è¡ŒçŠ¶æ€</h3><ul><li>é˜»å¡è°ƒç”¨æ˜¯æŒ‡è°ƒç”¨ç»“æœè¿”å›ä¹‹å‰å½“å‰çº¿ç¨‹éƒ½ä¼šæŒ‚èµ·ï¼Œè¿›ç¨‹ç»™CPUä¼ è¾¾ä¸€ä¸ªä»»åŠ¡ä¹‹åï¼Œä¸€ç›´ç­‰å¾…CPUå¤„ç†å®Œæˆï¼Œç„¶åæ‰æ‰§è¡Œåé¢çš„æ“ä½œ</li><li>éé˜»å¡è°ƒç”¨æ˜¯æŒ‡ï¼Œå½“å‰è°ƒç”¨æ— è®ºæ˜¯å¦é©¬ä¸Šè¿”å›ï¼Œéƒ½ä¸ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œè¿›ç¨‹ç»™CPUä¼ è¾¾ä»»åŠ¡åï¼Œç»§ç»­å¤„ç†å½“å‰çº¿ç¨‹åç»­çš„æ“ä½œï¼Œéš”æ–­æ—¶é—´å†æ¥è¯¢é—®ä¹‹å‰çš„æ“ä½œæ˜¯å¦å®Œæˆ</li></ul><h3 id="å¼‚æ­¥å°±æ˜¯å¼‚æ­¥ï¼ŒåŒæ­¥æ‰æœ‰é˜»å¡ä¸éé˜»å¡ä¹‹åˆ†ï¼Œå¼‚æ­¥å¿…å®šæ˜¯éé˜»å¡çš„"><a href="#å¼‚æ­¥å°±æ˜¯å¼‚æ­¥ï¼ŒåŒæ­¥æ‰æœ‰é˜»å¡ä¸éé˜»å¡ä¹‹åˆ†ï¼Œå¼‚æ­¥å¿…å®šæ˜¯éé˜»å¡çš„" class="headerlink" title="å¼‚æ­¥å°±æ˜¯å¼‚æ­¥ï¼ŒåŒæ­¥æ‰æœ‰é˜»å¡ä¸éé˜»å¡ä¹‹åˆ†ï¼Œå¼‚æ­¥å¿…å®šæ˜¯éé˜»å¡çš„"></a>å¼‚æ­¥å°±æ˜¯å¼‚æ­¥ï¼ŒåŒæ­¥æ‰æœ‰é˜»å¡ä¸éé˜»å¡ä¹‹åˆ†ï¼Œå¼‚æ­¥å¿…å®šæ˜¯éé˜»å¡çš„</h3><hr><p>æˆ‘çš„:</p><ul><li>ğŸ€ ğŸ€ ğŸ€&gt;&gt;&gt;&gt;&gt;&gt;&gt;<a href="https://blog.csdn.net/axela30w" target="_blank" rel="noopener">CSDN</a>&lt;&lt;&lt;&lt;&lt;&lt;&lt;ğŸ€ ğŸ€ ğŸ€</li><li>ğŸ€ ğŸ€ ğŸ€&gt;&gt;&gt;&gt;&gt;&gt;&gt;<a href="https://github.com/MistraR" target="_blank" rel="noopener">GitHub</a>&lt;&lt;&lt;&lt;&lt;&lt;&lt;ğŸ€ ğŸ€ ğŸ€</li><li>ğŸ€ ğŸ€ ğŸ€&gt;&gt;&gt;&gt;&gt;&gt;&gt;<a href="http://mistra.wang/">ä¸ªäººåšå®¢</a>&lt;&lt;&lt;&lt;&lt;&lt;&lt;ğŸ€ ğŸ€ ğŸ€</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;åŒæ­¥å’Œå¼‚æ­¥å…³æ³¨çš„æ˜¯æ¶ˆæ¯é€šä¿¡æœºåˆ¶ï¼Œé’ˆå¯¹åº”ç”¨ç¨‹åºæ¥ï¼Œå…³æ³¨çš„æ˜¯ç¨‹åºä¸­é—´çš„åä½œå…³ç³»&quot;&gt;&lt;a href=&quot;#åŒæ­¥å’Œå¼‚æ­¥å…³æ³¨çš„æ˜¯æ¶ˆæ¯é€šä¿¡æœºåˆ¶ï¼Œé’ˆå¯¹åº”ç”¨ç¨‹åºæ¥ï¼Œå…³æ³¨çš„æ˜¯ç¨‹åºä¸­é—´çš„åä½œå…³ç³»&quot; class=&quot;headerlink&quot; title=&quot;åŒæ­¥å’Œå¼‚æ­¥å…³æ³¨çš„æ˜¯æ¶ˆæ¯é€šä¿¡æœºåˆ¶ï¼Œé’ˆå¯¹
      
    
    </summary>
    
      <category term="IO/NIO" scheme="http://mistra.wang/categories/IO-NIO/"/>
    
    
      <category term="åŒæ­¥/å¼‚æ­¥" scheme="http://mistra.wang/tags/%E5%90%8C%E6%AD%A5-%E5%BC%82%E6%AD%A5/"/>
    
      <category term="é˜»å¡/éé˜»å¡" scheme="http://mistra.wang/tags/%E9%98%BB%E5%A1%9E-%E9%9D%9E%E9%98%BB%E5%A1%9E/"/>
    
  </entry>
  
  <entry>
    <title>GRPCåˆä½“éªŒä¹‹Javaç®€å•å®ä¾‹</title>
    <link href="http://mistra.wang/2019/05/02/GRPC%E5%88%9D%E4%BD%93%E9%AA%8C%E4%B9%8BJava%E7%AE%80%E5%8D%95%E5%AE%9E%E4%BE%8B/"/>
    <id>http://mistra.wang/2019/05/02/GRPCåˆä½“éªŒä¹‹Javaç®€å•å®ä¾‹/</id>
    <published>2019-05-02T07:11:47.000Z</published>
    <updated>2019-05-05T02:46:54.537Z</updated>
    
    <content type="html"><![CDATA[<p>å…³äºRPCè¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼Œåˆ†å¸ƒå¼æ¶æ„ä¸‹ä¸åŒæœåŠ¡ä¹‹é—´è°ƒç”¨è¶Šæ¥è¶Šç´§å¯†ï¼Œå¯¹è°ƒç”¨æ•ˆç‡ï¼Œå¯é æ€§ï¼Œå¯ç”¨æ€§è¦æ±‚è¶Šæ¥è¶Šé«˜ã€‚RPCå°±æ˜¯åœ¨æ­¤ç¯å¢ƒä¸‹åº”è¿è€Œç”Ÿçš„ã€‚éœ€è¦ç»“åˆæœåŠ¡æ³¨å†Œä¸­å¿ƒä¸€èµ·ä½¿ç”¨ã€‚Eurekaï¼ŒZookeeperï¼ŒConsulï¼ŒEtcdç­‰ç­‰ã€‚</p><ul><li><strong>å®¢æˆ·ç«¯ï¼ŒæœåŠ¡ç«¯ï¼ŒRPCä¹‹é—´çš„é€šè®¯</strong>:  ä¸€ä¸ªæœåŠ¡è‡ªå·±å¯ä»¥æ˜¯å®¢æˆ·ç«¯åŒæ—¶ä¹Ÿæ˜¯æœåŠ¡ç«¯ã€‚æœ€å¥½é‡‡ç”¨TCPè¿æ¥ï¼Œä¼ è¾“å±‚çš„TCPé“¾æ¥æ¯”åº”ç”¨å±‚çš„HTTPé“¾æ¥æ›´é«˜æ•ˆå¿«é€Ÿï¼Œè¿œç¨‹è¿‡ç¨‹è°ƒç”¨çš„æ‰€æœ‰æ•°æ®éƒ½åœ¨è¿™ä¸ªè¿æ¥é‡Œä¼ è¾“ã€‚</li><li><strong>æ•°æ®ä¼ è¾“</strong>: è¯·æ±‚å‚æ•°å’Œå“åº”æ•°æ®éƒ½éœ€è¦åºåˆ—åŒ–æˆäºŒè¿›åˆ¶æ•°æ®åœ¨ç½‘ç»œä¸Šä¼ è¾“ï¼Œæ¥æ”¶æ•°æ®æ—¶ååºåˆ—åŒ–ã€‚</li><li><p><strong>æœåŠ¡åœ°å€</strong>: ç»“åˆæœåŠ¡æ³¨å†Œä¸­å¿ƒã€‚è¯·æ±‚æŸä¸ªæœåŠ¡æˆ‘éœ€è¦çŸ¥é“è¯¥æœåŠ¡çš„åœ°å€URLï¼Œç«¯å£å·ï¼Œæ–¹æ³•åç­‰ç­‰ã€‚WebæœåŠ¡åè®®æ ˆçš„RPCï¼Œå°±è¦æä¾›ä¸€ä¸ªendpoint URIã€‚<br>æœåŠ¡è°ƒç”¨æµç¨‹ï¼Œå€Ÿç”¨åˆ«äººä¸€å¼ å›¾ï¼š<br><img src="https://markdown-mistra.oss-cn-shenzhen.aliyuncs.com/20181127170832836.jpeg" alt><br>1ï¼‰æœåŠ¡æ¶ˆè´¹æ–¹ï¼ˆclientï¼‰è°ƒç”¨ä»¥æœ¬åœ°è°ƒç”¨æ–¹å¼è°ƒç”¨æœåŠ¡ï¼›<br>2ï¼‰client stubæ¥æ”¶åˆ°è°ƒç”¨åè´Ÿè´£å°†æ–¹æ³•ã€å‚æ•°ç­‰ç»„è£…æˆèƒ½å¤Ÿè¿›è¡Œç½‘ç»œä¼ è¾“çš„æ¶ˆæ¯ä½“ï¼›<br>3ï¼‰client stubæ‰¾åˆ°æœåŠ¡åœ°å€ï¼Œå¹¶å°†æ¶ˆæ¯å‘é€åˆ°æœåŠ¡ç«¯ï¼›<br>4ï¼‰server stubæ”¶åˆ°æ¶ˆæ¯åè¿›è¡Œè§£ç ï¼›<br>5ï¼‰server stubæ ¹æ®è§£ç ç»“æœè°ƒç”¨æœ¬åœ°çš„æœåŠ¡ï¼›<br>6ï¼‰æœ¬åœ°æœåŠ¡æ‰§è¡Œå¹¶å°†ç»“æœè¿”å›ç»™server stubï¼›<br>7ï¼‰server stubå°†è¿”å›ç»“æœæ‰“åŒ…æˆæ¶ˆæ¯å¹¶å‘é€è‡³æ¶ˆè´¹æ–¹ï¼›<br>8ï¼‰client stubæ¥æ”¶åˆ°æ¶ˆæ¯ï¼Œå¹¶è¿›è¡Œè§£ç ï¼›<br>9ï¼‰æœåŠ¡æ¶ˆè´¹æ–¹å¾—åˆ°æœ€ç»ˆç»“æœã€‚<br>RPCçš„ç›®æ ‡å°±æ˜¯è¦2~8è¿™äº›æ­¥éª¤éƒ½å°è£…èµ·æ¥ã€‚</p><p>å‚è€ƒæ–‡ç« ï¼š<br><a href="https://blog.csdn.net/u013521220/article/details/70157956" target="_blank" rel="noopener">https://blog.csdn.net/u013521220/article/details/70157956</a><br><a href="https://blog.csdn.net/KingCat666/article/details/78577079" target="_blank" rel="noopener">https://blog.csdn.net/KingCat666/article/details/78577079</a></p></li></ul><hr><h3 id="ä¸€ã€gRPC-Java-å®ä¾‹"><a href="#ä¸€ã€gRPC-Java-å®ä¾‹" class="headerlink" title="ä¸€ã€gRPC Java å®ä¾‹"></a>ä¸€ã€gRPC Java å®ä¾‹</h3><p>å®˜æ–¹æ–‡æ¡£ï¼š<a href="http://doc.oschina.net/grpc?t=58008" target="_blank" rel="noopener">http://doc.oschina.net/grpc?t=58008</a><br>æœ¬å®ä¾‹GitHubåœ°å€ï¼š<a href="https://github.com/MistraR/grpc-java-mistra" target="_blank" rel="noopener">https://github.com/MistraR/grpc-java-mistra</a><br>gRPC ä¸€å¼€å§‹ç”± google å¼€å‘ï¼Œæ˜¯ä¸€æ¬¾è¯­è¨€ä¸­ç«‹ã€å¹³å°ä¸­ç«‹ã€å¼€æºçš„è¿œç¨‹è¿‡ç¨‹è°ƒç”¨(RPC)ç³»ç»Ÿã€‚<br>æœ¬æ–‡å†™ä¸ªgRPCçš„å°æ —å­ã€‚<br>gRPC é»˜è®¤ä½¿ç”¨ protocol buffersï¼Œè¿™æ˜¯ Google å¼€æºçš„ä¸€å¥—æˆç†Ÿçš„ç»“æ„æ•°æ®åºåˆ—åŒ–æœºåˆ¶ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–æ•°æ®æ ¼å¼å¦‚ JSONï¼‰ã€‚æ­£å¦‚ä½ å°†åœ¨ä¸‹æ–¹ä¾‹å­é‡Œæ‰€çœ‹åˆ°çš„ï¼Œä½ ç”¨ proto files åˆ›å»º gRPC æœåŠ¡ï¼Œç”¨ protocol buffers æ¶ˆæ¯ç±»å‹æ¥å®šä¹‰æ–¹æ³•å‚æ•°å’Œè¿”å›ç±»å‹ã€‚æœ¬æ–‡ä½¿ç”¨â€œproto3â€ç‰ˆæœ¬ã€‚<br>æ–°å»ºä¸€ä¸ªmavenå·¥ç¨‹<br>pom.xml</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;</span><br><span class="line">         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;groupId&gt;com.grpc&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;mistra&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</span><br><span class="line"></span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;</span><br><span class="line">        &lt;grpc.version&gt;1.9.1&lt;/grpc.version&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;io.grpc&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;grpc-netty&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;grpc.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;io.grpc&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;grpc-protobuf&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;grpc.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;io.grpc&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;grpc-stub&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;grpc.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;io.protostuff&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;protostuff-core&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.6.0&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;io.protostuff&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;protostuff-runtime&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.6.0&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;extensions&gt;</span><br><span class="line">            &lt;extension&gt;</span><br><span class="line">                &lt;groupId&gt;kr.motd.maven&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;os-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;1.5.0.Final&lt;/version&gt;</span><br><span class="line">            &lt;/extension&gt;</span><br><span class="line">        &lt;/extensions&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.xolstice.maven.plugins&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;protobuf-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;0.5.1&lt;/version&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;protocArtifact&gt;com.google.protobuf:protoc:3.5.1-1:exe:$&#123;os.detected.classifier&#125;&lt;/protocArtifact&gt;</span><br><span class="line">                    &lt;pluginId&gt;grpc-java&lt;/pluginId&gt;</span><br><span class="line">                    &lt;pluginArtifact&gt;io.grpc:protoc-gen-grpc-java:1.11.0:exe:$&#123;os.detected.classifier&#125;&lt;/pluginArtifact&gt;</span><br><span class="line">                &lt;/configuration&gt;</span><br><span class="line">                &lt;executions&gt;</span><br><span class="line">                    &lt;execution&gt;</span><br><span class="line">                        &lt;goals&gt;</span><br><span class="line">                            &lt;goal&gt;compile&lt;/goal&gt;</span><br><span class="line">                            &lt;goal&gt;compile-custom&lt;/goal&gt;</span><br><span class="line">                        &lt;/goals&gt;</span><br><span class="line">                    &lt;/execution&gt;</span><br><span class="line">                &lt;/executions&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;source&gt;1.8&lt;/source&gt;</span><br><span class="line">                    &lt;target&gt;1.8&lt;/target&gt;</span><br><span class="line">                &lt;/configuration&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">        &lt;/plugins&gt;</span><br><span class="line">    &lt;/build&gt;</span><br><span class="line"></span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure><p>æ–°å»ºprotoæ–‡ä»¶ï¼Œæ³¨æ„åŒ…ç»“æ„<br><img src="https://img-blog.csdnimg.cn/20181127170237246.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0F4ZWxhMzBX,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>helloworld.proto<br>æ³¨æ„java_packageçš„å€¼æœ€å¥½è·Ÿä½ ç­‰ä¼šè¦æ‹·è´è¿™äº›ç”Ÿæˆç±»å­˜æ”¾çš„ç›®å½•ä¸€è‡´ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">syntax = &quot;proto3&quot;;</span><br><span class="line"></span><br><span class="line">option java_multiple_files = true;</span><br><span class="line">//ç”Ÿæˆjavaä»£ç çš„package</span><br><span class="line">option java_package = &quot;com.grpc.mistra.generate&quot;;</span><br><span class="line">//åˆ›å»ºçš„javaBeançš„æ–‡ä»¶å</span><br><span class="line">option java_outer_classname = &quot;MistraProto&quot;;</span><br><span class="line">// å¯ä»¥ç”Ÿæˆrpcæ¥å£</span><br><span class="line">//option java_generic_services = true;</span><br><span class="line"></span><br><span class="line">package mistra;</span><br><span class="line"></span><br><span class="line">//å£°æ˜ä¸€ä¸ªæœåŠ¡åç§°</span><br><span class="line">service MistraService &#123;</span><br><span class="line">  //è¯·æ±‚å‚æ•°MistraRequest   å“åº”å‚æ•°MistraResponse</span><br><span class="line">  rpc SayHello (MistraRequest) returns (MistraResponse);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//è¯·æ±‚</span><br><span class="line">message MistraRequest &#123;</span><br><span class="line">  string name = 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//å“åº”</span><br><span class="line">message MistraResponse &#123;</span><br><span class="line">  string message = 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>è¿™ä¸ªæ—¶å€™å°±å¯ä»¥æ ¹æ®protoæ–‡ä»¶ç”ŸæˆåŸºæœ¬ç±»äº†ï¼Œmaven installï¼Œç„¶åå°±åœ¨targetæ–‡ä»¶å¤¹ä¸‹çœ‹è§ç”Ÿæˆçš„ç±»ï¼š<br><img src="https://img-blog.csdnimg.cn/20181127170406122.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0F4ZWxhMzBX,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>æŠŠçœ‹åˆ°çš„è¿™6ä¸ªç±»éƒ½æ‹·è´åˆ°ä¸»ç›®å½•ä¸‹ã€‚ç„¶åæ–°å»ºä¸€ä¸ªclientç±»ï¼Œæ–°å»ºä¸€ä¸ªserverç±»ã€‚æœ€åç›®å½•ç»“æ„å¦‚ä¸‹ï¼š<br><img src="https://img-blog.csdnimg.cn/20181127170528202.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0F4ZWxhMzBX,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>ç¼–å†™Client</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">package com.grpc.mistra.client;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import com.grpc.mistra.generate.MistraRequest;</span><br><span class="line">import com.grpc.mistra.generate.MistraResponse;</span><br><span class="line">import com.grpc.mistra.generate.MistraServiceGrpc;</span><br><span class="line">import io.grpc.ManagedChannel;</span><br><span class="line">import io.grpc.ManagedChannelBuilder;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @Author: WangRui</span><br><span class="line"> * @Date: 2018/11/27</span><br><span class="line"> * Time: 14:46</span><br><span class="line"> * Description:</span><br><span class="line"> */</span><br><span class="line">public class MistraClient &#123;</span><br><span class="line"></span><br><span class="line">    private final ManagedChannel channel;</span><br><span class="line">    private final MistraServiceGrpc.MistraServiceBlockingStub blockingStub;</span><br><span class="line"></span><br><span class="line">    public MistraClient(String host, int port) &#123;</span><br><span class="line">        channel = ManagedChannelBuilder.forAddress(host, port)</span><br><span class="line">                .usePlaintext(true)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        blockingStub = MistraServiceGrpc.newBlockingStub(channel);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void shutdown() throws InterruptedException &#123;</span><br><span class="line">        channel.shutdown().awaitTermination(5, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void greet(String name) &#123;</span><br><span class="line">        MistraRequest request = MistraRequest.newBuilder().setName(name).build();</span><br><span class="line">        MistraResponse response = blockingStub.sayHello(request);</span><br><span class="line">        System.out.println(response.getMessage());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws InterruptedException &#123;</span><br><span class="line">        MistraClient client = new MistraClient(&quot;127.0.0.1&quot;, 8001);</span><br><span class="line">        System.out.println(&quot;-------------------å®¢æˆ·ç«¯å¼€å§‹è®¿é—®è¯·æ±‚-------------------&quot;);</span><br><span class="line">        for (int i = 0; i &lt; 10; i++) &#123;</span><br><span class="line">            client.greet(&quot;ä½ è‹¥æƒ³ç”Ÿå­˜ï¼Œç»å¤„ä¹Ÿèƒ½ç¼ç”Ÿ: &quot; + i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>server</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">package com.grpc.mistra.server;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import com.grpc.mistra.generate.MistraRequest;</span><br><span class="line">import com.grpc.mistra.generate.MistraResponse;</span><br><span class="line">import com.grpc.mistra.generate.MistraServiceGrpc;</span><br><span class="line">import io.grpc.BindableService;</span><br><span class="line">import io.grpc.Server;</span><br><span class="line">import io.grpc.ServerBuilder;</span><br><span class="line">import io.grpc.stub.StreamObserver;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @Author: WangRui</span><br><span class="line"> * @Date: 2018/11/27</span><br><span class="line"> * Time: 14:46</span><br><span class="line"> * Description:</span><br><span class="line"> */</span><br><span class="line">public class MistraServer &#123;</span><br><span class="line"></span><br><span class="line">    private int port = 8001;</span><br><span class="line">    private Server server;</span><br><span class="line"></span><br><span class="line">    private void start() throws IOException &#123;</span><br><span class="line">        server = ServerBuilder.forPort(port)</span><br><span class="line">                .addService((BindableService) new MistraHelloWorldImpl())</span><br><span class="line">                .build()</span><br><span class="line">                .start();</span><br><span class="line"></span><br><span class="line">        System.out.println(&quot;------------------- æœåŠ¡ç«¯æœåŠ¡å·²å¼€å¯ï¼Œç­‰å¾…å®¢æˆ·ç«¯è®¿é—® -------------------&quot;);</span><br><span class="line"></span><br><span class="line">        Runtime.getRuntime().addShutdownHook(new Thread() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line"></span><br><span class="line">                System.err.println(&quot;*** shutting down gRPC server since JVM is shutting down&quot;);</span><br><span class="line">                MistraServer.this.stop();</span><br><span class="line">                System.err.println(&quot;*** server shut down&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void stop() &#123;</span><br><span class="line">        if (server != null) &#123;</span><br><span class="line">            server.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void blockUntilShutdown() throws InterruptedException &#123;</span><br><span class="line">        if (server != null) &#123;</span><br><span class="line">            server.awaitTermination();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws IOException, InterruptedException &#123;</span><br><span class="line">        final MistraServer server = new MistraServer();</span><br><span class="line">        //å¯åŠ¨æœåŠ¡</span><br><span class="line">        server.start();</span><br><span class="line">        //æœåŠ¡ä¸€ç›´åœ¨çº¿ï¼Œä¸å…³é—­</span><br><span class="line">        server.blockUntilShutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // å®šä¹‰ä¸€ä¸ªå®ç°æœåŠ¡æ¥å£çš„ç±»</span><br><span class="line">    private class MistraHelloWorldImpl extends MistraServiceGrpc.MistraServiceImplBase &#123;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void sayHello(MistraRequest mistraRequest, StreamObserver&lt;MistraResponse&gt; responseObserver) &#123;</span><br><span class="line">            // å…·ä½“å…¶ä»–ä¸°å¯Œçš„ä¸šåŠ¡å®ç°ä»£ç </span><br><span class="line">            System.err.println(&quot;server:&quot; + mistraRequest.getName());</span><br><span class="line">            MistraResponse reply = MistraResponse.newBuilder().setMessage((&quot;å“åº”ä¿¡æ¯: &quot; + mistraRequest.getName())).build();</span><br><span class="line">            responseObserver.onNext(reply);</span><br><span class="line">            responseObserver.onCompleted();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œserverçš„mainæ–¹æ³•ï¼Œå¯åŠ¨æœåŠ¡ã€‚<br>è¿è¡Œclientç«¯è®¿é—®æœåŠ¡ã€‚</p><h2 id><a href="#" class="headerlink" title></a><img src="https://img-blog.csdnimg.cn/20181127170805687.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0F4ZWxhMzBX,size_16,color_FFFFFF,t_70" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></h2><p>æˆ‘çš„:</p><ul><li>ğŸ€ ğŸ€ ğŸ€&gt;&gt;&gt;&gt;&gt;&gt;&gt;<a href="https://blog.csdn.net/axela30w" target="_blank" rel="noopener">CSDN</a>&lt;&lt;&lt;&lt;&lt;&lt;&lt;ğŸ€ ğŸ€ ğŸ€</li><li>ğŸ€ ğŸ€ ğŸ€&gt;&gt;&gt;&gt;&gt;&gt;&gt;<a href="https://github.com/MistraR" target="_blank" rel="noopener">GitHub</a>&lt;&lt;&lt;&lt;&lt;&lt;&lt;ğŸ€ ğŸ€ ğŸ€</li><li>ğŸ€ ğŸ€ ğŸ€&gt;&gt;&gt;&gt;&gt;&gt;&gt;<a href="http://mistra.wang/">ä¸ªäººåšå®¢</a>&lt;&lt;&lt;&lt;&lt;&lt;&lt;ğŸ€ ğŸ€ ğŸ€</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;å…³äºRPCè¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼Œåˆ†å¸ƒå¼æ¶æ„ä¸‹ä¸åŒæœåŠ¡ä¹‹é—´è°ƒç”¨è¶Šæ¥è¶Šç´§å¯†ï¼Œå¯¹è°ƒç”¨æ•ˆç‡ï¼Œå¯é æ€§ï¼Œå¯ç”¨æ€§è¦æ±‚è¶Šæ¥è¶Šé«˜ã€‚RPCå°±æ˜¯åœ¨æ­¤ç¯å¢ƒä¸‹åº”è¿è€Œç”Ÿçš„ã€‚éœ€è¦ç»“åˆæœåŠ¡æ³¨å†Œä¸­å¿ƒä¸€èµ·ä½¿ç”¨ã€‚Eurekaï¼ŒZookeeperï¼ŒConsulï¼ŒEtcdç­‰ç­‰ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;å®¢
      
    
    </summary>
    
      <category term="RPC" scheme="http://mistra.wang/categories/RPC/"/>
    
    
      <category term="GRPC" scheme="http://mistra.wang/tags/GRPC/"/>
    
  </entry>
  
  <entry>
    <title>SpringBootæ•´åˆShiroå®ç°ç”¨æˆ·ç™»å½•è®¤è¯å’Œæƒé™é‰´å®š</title>
    <link href="http://mistra.wang/2019/05/02/SpringBoot%E6%95%B4%E5%90%88Shiro%E5%AE%9E%E7%8E%B0%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81%E5%92%8C%E6%9D%83%E9%99%90%E9%89%B4%E5%AE%9A/"/>
    <id>http://mistra.wang/2019/05/02/SpringBootæ•´åˆShiroå®ç°ç”¨æˆ·ç™»å½•è®¤è¯å’Œæƒé™é‰´å®š/</id>
    <published>2019-05-02T07:06:43.000Z</published>
    <updated>2019-05-05T02:48:33.178Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ä¸€ã€Shiro"><a href="#ä¸€ã€Shiro" class="headerlink" title="ä¸€ã€Shiro"></a>ä¸€ã€Shiro</h3><p>Apache Shiroæ˜¯ä¸€ä¸ªJavaå®‰å…¨æ¡†æ¶,ç”¨æ¥åšèº«ä»½éªŒè¯(ç”¨æˆ·ç™»å½•)ã€æˆæƒ(æƒé™æ§åˆ¶)ã€å¯†ç å’Œä¼šè¯ç®¡ç†ã€‚å¸¸ç”¨çš„å°±æ˜¯å‰ä¸¤ä¸ªæ¨¡å—ã€‚Shiroé…ç½®ç®€å•ï¼Œä½¿ç”¨èµ·æ¥æ— å€¾å…¥æ€§ã€‚æ¯”SpringSecurityæ›´è½»é‡çº§ã€‚<br>å…ˆå¯¹3ä¸ªæ ¸å¿ƒç»„ä»¶ç±»æœ‰ä¸ªå°è±¡ï¼Œä¸€å®šå…ˆç†è§£è¿™ä¸‰ä¸ªä¸œè¥¿ï¼Œå¯¹åé¢å†™ä»£ç å’Œè®¾è®¡æœ‰å¸®åŠ©ï¼š</p><ul><li>Subjectï¼šå¯ä»¥æŠŠå®ƒçœ‹æˆ<strong>å½“å‰è¯·æ±‚è®¿é—®ç³»ç»Ÿçš„ç”¨æˆ·</strong>ã€‚ä¼šå­˜å‚¨å½“å‰ç”¨æˆ·çš„ä¿¡æ¯ï¼Œç”¨æˆ·åå¯†ç ç­‰ç­‰ã€‚</li><li>SecurityManagerï¼š<strong>ç®¡ç†æ‰€æœ‰ç”¨æˆ·çš„å®‰å…¨æ“ä½œ</strong>ã€‚å®ƒæ˜¯Shiroæ¡†æ¶çš„æ ¸å¿ƒï¼ŒShiroé€šè¿‡SecurityManageræ¥<strong>ç®¡ç†å†…éƒ¨å„ä¸ªç»„ä»¶</strong>å®ä¾‹ï¼Œå¹¶é€šè¿‡å®ƒæ¥æä¾›å®‰å…¨ç®¡ç†çš„å„ç§æœåŠ¡ã€‚æƒé™éªŒè¯ç­‰ç­‰ã€‚</li><li>Realmï¼š å½“å¯¹ç”¨æˆ·æ‰§è¡Œè®¤è¯ï¼ˆç™»å½•ï¼‰å’Œæˆæƒï¼ˆè®¿é—®æ§åˆ¶ï¼‰éªŒè¯æ—¶ï¼ŒShiroä¼šä»åº”ç”¨é…ç½®çš„Realm(è‡ªå·±å®šä¹‰è¿™ä¸ªRealm)éªŒè¯ç”¨æˆ·åŠå…¶æƒé™ä¿¡æ¯ã€‚</li></ul><hr><h3 id="äºŒã€è®¾è®¡æ–¹æ¡ˆ"><a href="#äºŒã€è®¾è®¡æ–¹æ¡ˆ" class="headerlink" title="äºŒã€è®¾è®¡æ–¹æ¡ˆ"></a>äºŒã€è®¾è®¡æ–¹æ¡ˆ</h3><p>æœ¬æ–‡åªæ˜¯ä»‹ç»Shiroçš„åŸºæœ¬ä½¿ç”¨å’Œä¸€èˆ¬ç³»ç»Ÿçš„ç™»å½•ï¼Œæƒé™æ¨¡å—è®¾è®¡æ€è·¯ã€‚</p><ul><li>system_user(idã€usernameã€passwordã€role_id&lt;system_role.id&gt;)ï¼šç”¨æˆ·è¡¨</li><li>system_role(idã€role_name)ï¼šè§’è‰²è¡¨</li><li>system_resources(idã€resources_nameã€resources_urlã€permission_code)ï¼šç³»ç»Ÿèµ„æºè¡¨ï¼Œresources_urlå°±æ˜¯è¯¥èµ„æºçš„è¯·æ±‚è·¯å¾„ï¼Œè­¬å¦‚ä¸€ä¸ªæ¥å£è¯·æ±‚è·¯å¾„ï¼Œpermission_codeæ˜¯ä½¿ç”¨Shiroçš„æƒé™æ§åˆ¶æ³¨è§£æ˜¯éœ€è¦ç”¨åˆ°çš„codeï¼Œåé¢ä¼šçœ‹åˆ°ã€‚æ­¤è¡¨æœ‰æ¡æ•°æ®ã€1ï¼Œç”¨æˆ·åˆ—è¡¨ï¼Œ/user/getListï¼Œpermis[get]ã€‘åé¢ä¼šç”¨åˆ°ï¼ï¼ï¼ï¼</li><li>role_resources(idã€role_id&lt;system_role.id&gt;ã€resources_id&lt;system_resources.id&gt;)ï¼šè§’è‰²èµ„æºå…³è”è¡¨<br>å¤§è‡´è¡¨ç»“æ„å¦‚ä¸Šï¼Œå¾ˆæ¸…æ™°æ˜“æ‡‚ã€‚<br>ç³»ç»Ÿæ¯ä¸ªç”¨æˆ·å¯¹åº”ä¸€ä¸ªè§’è‰²(æœ¬æ–‡å°±è®¾è®¡ä¸ºä¸€ä¸ªç”¨æˆ·åªæœ‰ä¸€ä¸ªè§’è‰²ï¼Œå½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥è®¾è®¡å¤šä¸ªè§’è‰²çš„æƒ…å†µ)ã€‚<br><strong>ä¼ ç»Ÿçš„æƒé™æ§åˆ¶æ‰‹æ®µå¯èƒ½å°±æ˜¯ï¼šç”¨æˆ·ç™»å½•â€“&gt;æŸ¥è¯¢æ•°æ®åº“ç”¨æˆ·åå’Œå¯†ç æ˜¯å¦åŒ¹é…â€“&gt;åŒ¹é…çš„è¯æ ¹æ®å½“å‰ç”¨æˆ·çš„role_idåœ¨è§’è‰²èµ„æºå…³è”è¡¨æŸ¥è¯¢åˆ°è¯¥è§’è‰²æ‹¥æœ‰çš„èµ„æºidé›†åˆâ€“&gt;å…³è”ç³»ç»Ÿèµ„æºè¡¨â€“&gt;å†å»åˆ¤æ–­è¯¥ç”¨æˆ·æ˜¯å¦æœ‰æ­¤èµ„æºçš„æƒé™ã€‚Shiroå¯ä»¥åŒ…æ½æ•´ä¸ªè¿‡ç¨‹ã€‚</strong></li></ul><hr><h3 id="ä¸‰ã€å®ç°"><a href="#ä¸‰ã€å®ç°" class="headerlink" title="ä¸‰ã€å®ç°"></a>ä¸‰ã€å®ç°</h3><p>ä¸€æ­¥ä¸€æ­¥çœ‹ç€æ¥ï¼Œä¸è¦ç€æ€¥ã€‚æ…¢æ…¢ç†è§£ï¼Œæˆ‘åº”è¯¥å†™çš„å¾ˆè¯¦ç»†äº†ï¼Œä¸éš¾æ‡‚ã€‚(è¿™é‡Œåªåˆ—æ ¸å¿ƒä»£ç )<br>pom.xml  Shiroä¾èµ–</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.shiro&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;shiro-spring&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.4.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.shiro&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;shiro-ehcache&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.4.0&lt;/version&gt;</span><br><span class="line">    &lt;exclusions&gt;</span><br><span class="line">        &lt;exclusion&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.shiro&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;shiro-core&lt;/artifactId&gt;</span><br><span class="line">        &lt;/exclusion&gt;</span><br><span class="line">    &lt;/exclusions&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-aspects&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;5.0.7.RELEASE&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><p>æœ¬æ–‡åªåšä¸¤ä¸ªäº‹ï¼ŒæŠŠç”¨æˆ·ç™»å½•çš„éªŒè¯å’Œç”¨æˆ·æ˜¯å¦æ‹¥æœ‰æŸä¸ªæ¥å£çš„è¯·æ±‚æƒé™äº¤ç»™Shiroæ¥å¤„ç†ã€‚</p><h4 id="1ã€å…ˆè§£å†³ç”¨æˆ·ç™»å½•é—®é¢˜"><a href="#1ã€å…ˆè§£å†³ç”¨æˆ·ç™»å½•é—®é¢˜" class="headerlink" title="1ã€å…ˆè§£å†³ç”¨æˆ·ç™»å½•é—®é¢˜"></a>1ã€å…ˆè§£å†³ç”¨æˆ·ç™»å½•é—®é¢˜</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line"><span class="comment">//çœç•¥äº†å…¶ä»–çš„å¸¸è§„ä»£ç ï¼Œæ¯”å¦‚åˆ¤æ–­å­—æ®µæ˜¯å¦ä¸ºç©ºä¹‹ç±»çš„</span></span><br><span class="line"><span class="comment">//æ­¤Subjectå°±æ˜¯å¼€å¤´æåˆ°çš„  ä»£è¡¨å½“å‰ç”¨æˆ·</span></span><br><span class="line">    Subject subject = SecurityUtils.getSubject();</span><br><span class="line">    <span class="comment">//ç”¨è¯·æ±‚çš„ç”¨æˆ·åå’Œå¯†ç åˆ›å»ºUsernamePasswordToken(æ­¤ç±»æ¥è‡ªshiroåŒ…ä¸‹)</span></span><br><span class="line">    UsernamePasswordToken usernamePasswordToken = <span class="keyword">new</span> UsernamePasswordToken(username, password);</span><br><span class="line">    <span class="comment">//è°ƒç”¨subject.loginè¿›è¡ŒéªŒè¯ï¼ŒéªŒè¯ä¸é€šè¿‡åˆ™ä¼šæŠ›å‡ºAuthenticationExceptionå¼‚å¸¸ï¼Œç„¶åè‡ªå®šä¹‰è¿”å›ä¿¡æ¯</span></span><br><span class="line">    subject.login(usernamePasswordToken);</span><br><span class="line">    <span class="comment">//æœªæŠ›å¼‚å¸¸ åˆ™éªŒè¯é€šè¿‡</span></span><br><span class="line">    <span class="comment">//æ­¤Sessionä¹Ÿæ¥è‡ªshiroåŒ…  æ˜¯å¯¹ä¼ ç»Ÿçš„HttpSessionçš„å°è£…ï¼Œå¯ä»¥çœ‹åšæ˜¯ä¸€æ ·çš„</span></span><br><span class="line">    Session session = subject.getSession();</span><br><span class="line">    <span class="comment">//ä¸‹é¢çš„æ˜¯è‡ªå®šä¹‰çš„ä»£ç ï¼Œéšä½ æ€ä¹ˆå†™</span></span><br><span class="line">    session.setAttribute(RequestConstans.USER_ID, checkUser.getId());</span><br><span class="line">&#125; <span class="keyword">catch</span> (AuthenticationException e) &#123;</span><br><span class="line"><span class="comment">//è¿™è¡Œä¹Ÿæ˜¯è‡ªå®šä¹‰çš„ä»£ç ï¼Œéšä½ æ€ä¹ˆå†™</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> BusinessException(BusinessErrorCode.USER_LOGIN_PWD_ERROR_FAIL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯æˆªå–çš„ç™»å½•æ¥å£çš„ä¸€éƒ¨åˆ†ä»£ç ï¼Œè¿™å°±æ˜¯ç™»å½•æ¥å£æ–¹æ³•çš„å¤„ç†äº†ï¼Œå¾ˆç®€å•ï¼Œé€šè¿‡subject.login(usernamePasswordToken);æ–¹æ³•ï¼Œå°±æŠŠç™»å½•éªŒè¯äº¤ç»™Shiroæ¥å¤„ç†äº†ã€‚çœç•¥äº†åŸæ¥è‡ªå·±å»åˆ¤æ–­ç”¨æˆ·åè·Ÿå¯†ç æ˜¯å¦åŒ¹é…çš„è¿‡ç¨‹ã€‚<br>æ‰©å±•ï¼š<a href="https://www.cnblogs.com/OnlyCT/p/8391274.html" target="_blank" rel="noopener">hiro sessionå’ŒSpring sessionä¸€æ ·å—ï¼Ÿ</a></p><h4 id="2ã€è‡ªå®šä¹‰çš„Realmï¼Œç”¨æ¥å¤„ç†ç™»å½•éªŒè¯ä¸é‰´æƒ"><a href="#2ã€è‡ªå®šä¹‰çš„Realmï¼Œç”¨æ¥å¤„ç†ç™»å½•éªŒè¯ä¸é‰´æƒ" class="headerlink" title="2ã€è‡ªå®šä¹‰çš„Realmï¼Œç”¨æ¥å¤„ç†ç™»å½•éªŒè¯ä¸é‰´æƒ"></a>2ã€è‡ªå®šä¹‰çš„Realmï¼Œç”¨æ¥å¤„ç†ç™»å½•éªŒè¯ä¸é‰´æƒ</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.web.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.mechat.backend.dao.CommercialMapper;</span><br><span class="line"><span class="keyword">import</span> com.mechat.backend.dao.SystemMenuMapper;</span><br><span class="line"><span class="keyword">import</span> com.mechat.backend.model.Commercial;</span><br><span class="line"><span class="keyword">import</span> com.mechat.backend.model.SystemMenu;</span><br><span class="line"><span class="keyword">import</span> com.mechat.backend.utils.UserConfig;</span><br><span class="line"><span class="keyword">import</span> com.mechat.common.auth.AESUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.AuthorizationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.SimpleAuthorizationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.realm.AuthorizingRealm;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.PrincipalCollection;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: WangRui</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2019/1/22</span></span><br><span class="line"><span class="comment"> * Time: 22:43</span></span><br><span class="line"><span class="comment"> * Description:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyShiroRealm</span> <span class="keyword">extends</span> <span class="title">AuthorizingRealm</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SystemMenuMapper systemMenuMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”¨æˆ·ç™»å½•è®¤è¯æ–¹æ³•</span></span><br><span class="line"><span class="comment">     * ä¸Šé¢ä¸æ˜¯è°ƒç”¨äº†subject.login()æ–¹æ³•å˜›ï¼Œå°±ä¼šè¿›å…¥åˆ°è¿™ä¸ªæ–¹æ³•æ¥è¿›è¡Œå…·ä½“ç™»å½•éªŒè¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken authenticationToken)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">    <span class="comment">//authenticationToken.getPrincipal()æ˜¯è·å¾—ç”¨æˆ·å</span></span><br><span class="line">        <span class="keyword">if</span> (authenticationToken.getPrincipal() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AuthenticationException(<span class="string">"è´¦å·åä¸ºç©ºï¼Œç™»å½•å¤±è´¥ï¼"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//è·å–ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">        String name = authenticationToken.getPrincipal().toString();</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setUserName(name);</span><br><span class="line">        <span class="comment">//é€šè¿‡ç”¨æˆ·ååœ¨æ•°æ®åº“æŸ¥åˆ°è¯¥ç”¨æˆ·çš„ä¿¡æ¯</span></span><br><span class="line">        user = userMapper.selectByPKey(user);</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//è¿™é‡Œè¿”å›åä¼šæŠ¥å‡ºå¯¹åº”å¼‚å¸¸</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AuthenticationException(<span class="string">"ä¸å­˜åœ¨çš„è´¦å·ï¼Œç™»å½•å¤±è´¥ï¼"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//è¿™é‡ŒéªŒè¯authenticationTokenå’ŒsimpleAuthenticationInfoçš„ä¿¡æ¯</span></span><br><span class="line">            <span class="comment">//getName()  æ˜¯ShiroåŒ…ä¸‹org.apache.shiro.realm.CachingRealmçš„æ–¹æ³•ï¼Œä¸æ˜¯è‡ªå®šä¹‰çš„</span></span><br><span class="line">            SimpleAuthenticationInfo simpleAuthenticationInfo = <span class="keyword">new</span> SimpleAuthenticationInfo(name, user.getPassword, getName());</span><br><span class="line">            <span class="keyword">return</span> simpleAuthenticationInfo;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”¨æˆ·é‰´æƒ</span></span><br><span class="line"><span class="comment">     * ç”¨æˆ·è¯·æ±‚æœ‰æƒé™è¦æ±‚çš„æ¥å£æ—¶è¦ç»è¿‡æ­¤è®¤è¯ï¼Œ</span></span><br><span class="line"><span class="comment">     * è­¬å¦‚æˆ‘åœ¨æŸä¸ªControllerçš„æ–¹æ³•ä¸ŠåŠ äº†æ³¨è§£<span class="doctag">@RequiresPermissions</span>(value = "permis[get]")ï¼Œ</span></span><br><span class="line"><span class="comment">     * é‚£ä¹ˆè¯¥ç”¨æˆ·çš„è§’è‰²æ‹¥æœ‰çš„èµ„æºå¿…é¡»è¦åŒ…å«â€œpermis[get]â€æƒé™æ‰èƒ½è®¿é—®æ­¤æ¥å£ï¼Œ</span></span><br><span class="line"><span class="comment">     * â€œpermis[get]â€å¯¹åº”æ–‡ç« å¼€å¤´è¯´çš„è¡¨ç»“æ„é‚£é‡Œçš„ç³»ç»Ÿèµ„æºè¡¨ä¸­çš„permission_code</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> principalCollection</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principalCollection)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//è·å–ç™»å½•ç”¨æˆ·åï¼Œæ­¤ç”¨æˆ·åæ˜¯åœ¨ç™»å½•æ¥å£é‡Œnew UsernamePasswordToken()æ—¶è®¾ç½®çš„</span></span><br><span class="line">        String account = (String) principalCollection.getPrimaryPrincipal();</span><br><span class="line">        <span class="comment">//æ·»åŠ è§’è‰²å’Œæƒé™</span></span><br><span class="line">        SimpleAuthorizationInfo simpleAuthorizationInfo = <span class="keyword">new</span> SimpleAuthorizationInfo();</span><br><span class="line">        <span class="comment">//æ ¹æ®ç”¨æˆ·è´¦å·æŸ¥è¯¢æ‹¥æœ‰çš„æ‰€æœ‰èµ„æºæƒé™  SystemMenuå¯¹åº”è¡¨system_resourcesï¼Œè¿™æ˜¯ä¸€æ¡å…³è”sqlï¼Œ</span></span><br><span class="line">        <span class="comment">//é€šè¿‡ç”¨æˆ·è´¦å·-æ‹¿åˆ°è§’è‰²id-åœ¨role_resourcesæŸ¥è¯¢åˆ°æ‹¥æœ‰çš„resources_id-ç„¶åå…³è”system_resourcesæŸ¥è¯¢åˆ°æ‹¥æœ‰çš„æ‰€æœ‰èµ„æº</span></span><br><span class="line">        List&lt;SystemMenu&gt; systemMenuList = systemMenuMapper.findUserPermission(account);</span><br><span class="line">        <span class="comment">//æ·»åŠ è§’è‰²   å› ä¸ºæ­¤æ¬¡åªå…³è”åˆ°æƒé™permissionï¼Œæ•…æš‚ä¸æ·»åŠ è§’è‰²ï¼Œåªé€šè¿‡permissionæ¥é‰´æƒ</span></span><br><span class="line">        <span class="comment">//æ·»åŠ è§’è‰²å¯¹åº”çš„ä½¿ç”¨æ³¨è§£æ˜¯ @RequiresRoles()</span></span><br><span class="line">        <span class="comment">//simpleAuthorizationInfo.save("admin");</span></span><br><span class="line">        <span class="comment">//æ·»åŠ æƒé™  åœ¨è¿™é‡Œå°±æŠŠè¯¥ç”¨æˆ·å¯¹åº”çš„è§’è‰²æ‹¥æœ‰çš„æ‰€æœ‰çš„æƒé™çš„permission_codeæ·»åŠ åˆ°Shiroäº†ï¼Œæ¯æ¬¡è®¿é—®å¸¦æœ‰æƒé™é™åˆ¶çš„æ¥å£æ—¶å°±ä¼šéªŒè¯ï¼Œæ‹¥æœ‰å¯¹åº”æƒé™codeçš„è¯å°±å¯ä»¥æ­£å¸¸è®¿é—®ã€‚</span></span><br><span class="line">        simpleAuthorizationInfo.addStringPermissions(systemMenuList.stream().map(systemMenu -&gt; systemMenu.getPermission()).collect(Collectors.toList()));</span><br><span class="line">        <span class="keyword">return</span> simpleAuthorizationInfo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨è§£ä½¿ç”¨å›¾è§£ï¼š<br><img src="https://markdown-mistra.oss-cn-shenzhen.aliyuncs.com/20190122225655661.png" alt><br>æ³¨æ„@RequiresPermissions(value = â€œpermis[get]â€) valueçš„å€¼å°±æ˜¯å¯¹åº”èµ„æºçš„permission_codeï¼Œè§å¼€å¤´è¡¨ç»“æ„è®¾è®¡é‚£é‡Œï¼ï¼ï¼æ¢å¥è¯è¯´ï¼Œæ­¤ç”¨æˆ·å¿…é¡»è¦æœ‰æ­¤èµ„æºæƒé™æ‰èƒ½è®¿é—®è¿™ä¸ªControlleræ–¹æ³•ã€‚</p><h4 id="3ã€securityManagerå®‰å…¨é…ç½®"><a href="#3ã€securityManagerå®‰å…¨é…ç½®" class="headerlink" title="3ã€securityManagerå®‰å…¨é…ç½®"></a>3ã€securityManagerå®‰å…¨é…ç½®</h4><p>è‡ªå®šä¹‰çš„MyShiroRealmå†™å¥½äº†ï¼Œè¦é…ç½®ä»–æ‰èƒ½ä½¿ç”¨ã€‚ä¸‹é¢å°±æ˜¯Shiroçš„é…ç½®ç±»äº†ï¼š<br>å®šä¹‰äº†ä¸€ä¸ªPropertiesï¼Œéœ€è¦å¿½ç•¥éªŒè¯çš„è¯·æ±‚è·¯å¾„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IgnoreAuthUrlProperties</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    List&lt;String&gt; ignoreAuthUrl;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getIgnoreAuthUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ignoreAuthUrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIgnoreAuthUrl</span><span class="params">(List&lt;String&gt; ignoreAuthUrl)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.ignoreAuthUrl = ignoreAuthUrl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹åº”çš„é…ç½®ï¼š<br><img src="https://markdown-mistra.oss-cn-shenzhen.aliyuncs.com/20190122230725850.png" alt><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.web.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.cache.CacheManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.cache.ehcache.EhCacheManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.mgt.SecurityManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.session.mgt.SessionManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.session.mgt.eis.EnterpriseCacheSessionDAO;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.session.mgt.eis.SessionDAO;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.security.interceptor.AuthorizationAttributeSourceAdvisor;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.web.ShiroFilterFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.mgt.DefaultWebSecurityManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.session.mgt.DefaultWebSessionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: WangRui</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2019/1/22</span></span><br><span class="line"><span class="comment"> * Time: 22:44</span></span><br><span class="line"><span class="comment"> * Description:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IgnoreAuthUrlProperties ignoreAuthUrlProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MyShiroRealm <span class="title">myShiroRealm</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        MyShiroRealm myShiroRealm = <span class="keyword">new</span> MyShiroRealm();</span><br><span class="line">        <span class="keyword">return</span> myShiroRealm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CacheManager <span class="title">cacheManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> EhCacheManager();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SessionDAO <span class="title">sessionDAO</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> EnterpriseCacheSessionDAO();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SessionManager <span class="title">sessionManager</span><span class="params">(SessionDAO sessionDAO)</span> </span>&#123;</span><br><span class="line">        DefaultWebSessionManager manager = <span class="keyword">new</span> DefaultWebSessionManager();</span><br><span class="line">        manager.setSessionDAO(sessionDAO);</span><br><span class="line">        <span class="comment">//è®¾ç½®sessionè¿‡æœŸæ—¶é—´</span></span><br><span class="line">        manager.setGlobalSessionTimeout(<span class="number">3600000</span>);</span><br><span class="line">        manager.setSessionValidationInterval(<span class="number">3600000</span>);</span><br><span class="line">        <span class="keyword">return</span> manager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æƒé™ç®¡ç†ï¼Œé…ç½®ä¸»è¦æ˜¯Realmçš„ç®¡ç†è®¤è¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SecurityManager <span class="title">securityManager</span><span class="params">(CacheManager cacheManager, SessionManager sessionManager)</span> </span>&#123;</span><br><span class="line">        DefaultWebSecurityManager securityManager = <span class="keyword">new</span> DefaultWebSecurityManager();</span><br><span class="line">        securityManager.setSessionManager(sessionManager);</span><br><span class="line">        securityManager.setRealm(myShiroRealm());</span><br><span class="line">        securityManager.setCacheManager(cacheManager);</span><br><span class="line">        <span class="keyword">return</span> securityManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Filterå·¥å‚ï¼Œè®¾ç½®å¯¹åº”çš„è¿‡æ»¤æ¡ä»¶å’Œè·³è½¬æ¡ä»¶  è¿™æ˜¯é‡ç‚¹ï¼ï¼ï¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ShiroFilterFactoryBean <span class="title">shiroFilterFactoryBean</span><span class="params">(SecurityManager securityManager)</span> </span>&#123;</span><br><span class="line">        ShiroFilterFactoryBean shiroFilterFactoryBean = <span class="keyword">new</span> ShiroFilterFactoryBean();</span><br><span class="line">        shiroFilterFactoryBean.setSecurityManager(securityManager);</span><br><span class="line">        Set&lt;String&gt; urlSet = <span class="keyword">new</span> HashSet&lt;&gt;(ignoreAuthUrlProperties.getIgnoreAuthUrl());</span><br><span class="line">        <span class="comment">//å¿…é¡»é‡‡ç”¨LinkedHashMapæœ‰åºå­˜å‚¨è¿‡æ»¤æ¡ä»¶ </span></span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">        <span class="comment">//anonè¡¨ç¤ºæ‰€æœ‰ç”¨æˆ·éƒ½å¯ä»¥ä¸é‰´æƒåŒ¿åè®¿é—®</span></span><br><span class="line">        urlSet.stream().forEach(temp -&gt; map.put(temp, <span class="string">"anon"</span>));</span><br><span class="line">        <span class="comment">//æ­¤è·¯å¾„å¿…é¡»æ”¾åœ¨æœ€å  è¿™æ˜¯ä¸ºå•¥ä¸€å®šä½¿ç”¨LinkedHashMapçš„åŸå› </span></span><br><span class="line">        map.put(<span class="string">"/**"</span>, <span class="string">"authc"</span>);</span><br><span class="line">        <span class="comment">//ç™»å½•</span></span><br><span class="line">        shiroFilterFactoryBean.setLoginUrl(<span class="string">"/login"</span>);</span><br><span class="line">        <span class="comment">//é¦–é¡µ</span></span><br><span class="line">        shiroFilterFactoryBean.setSuccessUrl(<span class="string">"/index"</span>);</span><br><span class="line">        shiroFilterFactoryBean.setUnauthorizedUrl(<span class="string">"/login"</span>);</span><br><span class="line">        shiroFilterFactoryBean.setFilterChainDefinitionMap(map);</span><br><span class="line">        <span class="keyword">return</span> shiroFilterFactoryBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åŠ å…¥shiroæ³¨è§£çš„ä½¿ç”¨ï¼Œä¸åŠ å…¥è¿™ä¸ªæ³¨è§£ä¸ç”Ÿæ•ˆ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthorizationAttributeSourceAdvisor <span class="title">authorizationAttributeSourceAdvisor</span><span class="params">(SecurityManager securityManager)</span> </span>&#123;</span><br><span class="line">        AuthorizationAttributeSourceAdvisor advisor = <span class="keyword">new</span> AuthorizationAttributeSourceAdvisor();</span><br><span class="line">        advisor.setSecurityManager(securityManager);</span><br><span class="line">        <span class="keyword">return</span> advisor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="è‡³æ¬¡ï¼ŒShiroçš„ç™»å½•éªŒè¯å’Œé‰´æƒç®—æ˜¯å¼€å‘å®Œæˆäº†ã€‚åªæ˜¯ç®€å•å®ç”¨ï¼ŒShiroè¿˜æœ‰å…¶ä»–å¾ˆå¼ºå¤§çš„åŠŸèƒ½ã€‚"><a href="#è‡³æ¬¡ï¼ŒShiroçš„ç™»å½•éªŒè¯å’Œé‰´æƒç®—æ˜¯å¼€å‘å®Œæˆäº†ã€‚åªæ˜¯ç®€å•å®ç”¨ï¼ŒShiroè¿˜æœ‰å…¶ä»–å¾ˆå¼ºå¤§çš„åŠŸèƒ½ã€‚" class="headerlink" title="è‡³æ¬¡ï¼ŒShiroçš„ç™»å½•éªŒè¯å’Œé‰´æƒç®—æ˜¯å¼€å‘å®Œæˆäº†ã€‚åªæ˜¯ç®€å•å®ç”¨ï¼ŒShiroè¿˜æœ‰å…¶ä»–å¾ˆå¼ºå¤§çš„åŠŸèƒ½ã€‚"></a>è‡³æ¬¡ï¼ŒShiroçš„ç™»å½•éªŒè¯å’Œé‰´æƒç®—æ˜¯å¼€å‘å®Œæˆäº†ã€‚åªæ˜¯ç®€å•å®ç”¨ï¼ŒShiroè¿˜æœ‰å…¶ä»–å¾ˆå¼ºå¤§çš„åŠŸèƒ½ã€‚</h2><p>æˆ‘çš„:</p><ul><li>ğŸ€ ğŸ€ ğŸ€&gt;&gt;&gt;&gt;&gt;&gt;&gt;<a href="https://blog.csdn.net/axela30w" target="_blank" rel="noopener">CSDN</a>&lt;&lt;&lt;&lt;&lt;&lt;&lt;ğŸ€ ğŸ€ ğŸ€</li><li>ğŸ€ ğŸ€ ğŸ€&gt;&gt;&gt;&gt;&gt;&gt;&gt;<a href="https://github.com/MistraR" target="_blank" rel="noopener">GitHub</a>&lt;&lt;&lt;&lt;&lt;&lt;&lt;ğŸ€ ğŸ€ ğŸ€</li><li>ğŸ€ ğŸ€ ğŸ€&gt;&gt;&gt;&gt;&gt;&gt;&gt;<a href="http://mistra.wang/">ä¸ªäººåšå®¢</a>&lt;&lt;&lt;&lt;&lt;&lt;&lt;ğŸ€ ğŸ€ ğŸ€</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;ä¸€ã€Shiro&quot;&gt;&lt;a href=&quot;#ä¸€ã€Shiro&quot; class=&quot;headerlink&quot; title=&quot;ä¸€ã€Shiro&quot;&gt;&lt;/a&gt;ä¸€ã€Shiro&lt;/h3&gt;&lt;p&gt;Apache Shiroæ˜¯ä¸€ä¸ªJavaå®‰å…¨æ¡†æ¶,ç”¨æ¥åšèº«ä»½éªŒè¯(ç”¨æˆ·ç™»å½•)ã€æˆæƒ(æƒé™æ§åˆ¶)ã€å¯†ç å’Œ
      
    
    </summary>
    
      <category term="Shiro" scheme="http://mistra.wang/categories/Shiro/"/>
    
    
      <category term="Shiro" scheme="http://mistra.wang/tags/Shiro/"/>
    
  </entry>
  
  <entry>
    <title>JsonWebToken(JWT)è®¾è®¡æ–¹æ¡ˆ</title>
    <link href="http://mistra.wang/2019/04/30/JsonWebToken(JWT)%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/"/>
    <id>http://mistra.wang/2019/04/30/JsonWebToken(JWT)è®¾è®¡æ–¹æ¡ˆ/</id>
    <published>2019-04-30T01:06:59.000Z</published>
    <updated>2019-05-05T02:41:23.552Z</updated>
    
    <content type="html"><![CDATA[<h4 id="Json-web-tokens-ï¼šå®˜ç½‘"><a href="#Json-web-tokens-ï¼šå®˜ç½‘" class="headerlink" title="Json web tokens ï¼šå®˜ç½‘"></a>Json web tokens ï¼š<a href="https://jwt.io/" target="_blank" rel="noopener">å®˜ç½‘</a></h4><hr><h3 id="What-JsonWebTokenæ˜¯ä»€ä¹ˆ"><a href="#What-JsonWebTokenæ˜¯ä»€ä¹ˆ" class="headerlink" title="What? - JsonWebTokenæ˜¯ä»€ä¹ˆ"></a>What? - JsonWebTokenæ˜¯ä»€ä¹ˆ</h3><p>è¯·æ±‚è®¿é—®åå°ï¼Œåå°éœ€è¦çŸ¥é“ä½ æ˜¯è°å§ï¼ŸTokenå°±æ˜¯ä¸€ä¸ªä»¤ç‰Œï¼Œæ¯æ¬¡è¯·æ±‚åå°éƒ½å¸¦ä¸Šå®ƒï¼Œè¯´æ˜ä½ æ˜¯è°ï¼Œå¹¶ä¸”å¯ä»¥æºå¸¦ä¸€äº›ä½ çš„ä¿¡æ¯ã€‚Tokenæ˜¯åå°æ ¹æ®ä½ é…ç½®çš„ç®—æ³•ï¼Œè¿˜æœ‰å¯†é’¥ï¼Œç¼–ç ç”Ÿæˆçš„ï¼Œæœ€ååœ¨é€šè¿‡base64åŠ å¯†è¿”ç»™è¯·æ±‚ã€‚<br>å®ƒé•¿è¿™ä¸ªæ ·å­ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c</span><br></pre></td></tr></table></figure><p>æ³¨æ„åˆ°ä¸¤ä¸ªâ€.â€åˆ†éš”ç¬¦äº†å˜›ï¼ŒTokenåˆ†æˆ3éƒ¨åˆ†ï¼Œä¸Šé¢æ˜¯base64åŠ å¯†çš„ï¼Œè§£å¯†ä¸€ä¸‹ï¼š<br><img src="https://img-blog.csdnimg.cn/20190424095904517.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0F4ZWxhMzBX,size_16,color_FFFFFF,t_70" alt><br>ç¬¬ä¸€éƒ¨åˆ†ï¼Œè¯´æ˜äº†ç”¨çš„ä»€ä¹ˆåŠ å¯†ç®—æ³•<br>ç¬¬äºŒéƒ¨åˆ†ï¼Œæ˜¯æˆ‘ä»¬æ‰‹åŠ¨æ”¾è¿›å»çš„éƒ¨åˆ†ä¿¡æ¯ï¼Œè­¬å¦‚æ”¾ç”¨æˆ·idä»€ä¹ˆçš„ï¼Œæ³¨æ„ä¸èƒ½æ”¾ç§å¯†ä¿¡æ¯ï¼Œå› ä¸ºè¿™éƒ¨åˆ†æ˜¯å¯ä»¥è§£å¯†çš„<br>ç¬¬ä¸‰éƒ¨åˆ†ï¼Œä¼šå‘ç°è§£å¯†ä¸äº†ï¼Œå› ä¸ºæˆ‘ä»¬ä¸çŸ¥é“åå°ç”¨çš„ä»€ä¹ˆå¯†é’¥ï¼Œsoï¼Œåˆ«äººæ˜¯æ²¡æ³•ä¼ªé€ tokenæ¥è®¿é—®ä½ çš„(tokenä¹Ÿæœ‰ç¼ºé™·ï¼Œåé¢ä¼šæåˆ°)</p><hr><h3 id="Why-ä¸ºä»€ä¹ˆè¦ç”¨Token"><a href="#Why-ä¸ºä»€ä¹ˆè¦ç”¨Token" class="headerlink" title="Why? - ä¸ºä»€ä¹ˆè¦ç”¨Token"></a>Why? - ä¸ºä»€ä¹ˆè¦ç”¨Token</h3><p>éƒ½çŸ¥é“sessionï¼ŒTokençš„å‡ºç°è§£å†³äº†ä½¿ç”¨sessionæ¥å­˜å‚¨ç”¨æˆ·èº«ä»½ä¿¡æ¯çš„ä¸€äº›å¼Šç«¯ï¼Œä¸¤ä¸ªå¯ä»¥æ ¹æ®å®é™…æƒ…å†µè§‰å¾—ç”¨å“ªç§ã€‚<br>å‚è€ƒï¼š<a href="https://www.cnblogs.com/xiaozhang2014/p/7750200.html" target="_blank" rel="noopener">Session,Tokenç›¸å…³åŒºåˆ«</a></p><hr><h3 id="How-ç”¨æˆ·èº«ä»½è®¤è¯å®Œæ•´è®¾è®¡æ–¹æ¡ˆ"><a href="#How-ç”¨æˆ·èº«ä»½è®¤è¯å®Œæ•´è®¾è®¡æ–¹æ¡ˆ" class="headerlink" title="How? - ç”¨æˆ·èº«ä»½è®¤è¯å®Œæ•´è®¾è®¡æ–¹æ¡ˆ"></a>How? - ç”¨æˆ·èº«ä»½è®¤è¯å®Œæ•´è®¾è®¡æ–¹æ¡ˆ</h3><p>Tokenå¿…é¡»æœ‰è¿‡æœŸæ—¶é—´ï¼Œä¸ç„¶ç™»å½•çš„æ—¶å€™ç”Ÿæˆä¸€æ¬¡ï¼Œåé¢çš„è¯·æ±‚æ‹¿ç€ä¸€ç›´è®¿é—®ä¹Ÿä¸åˆç†ï¼Œæ³„éœ²äº†Tokençš„è¯ä¸å®‰å…¨ã€‚<br><em>(æœ¬æ–‡åªèŠ‚é€‰éƒ¨åˆ†ä»£ç ï¼Œç€é‡è¯´ä¸‹è®¾è®¡æ–¹æ¡ˆï¼ŒTokençš„ä»£ç å®ç°ç½‘ä¸Šå¾ˆå¤š)</em><br>å…ˆçœ‹ä¸‹Tokenæ€ä¹ˆç”Ÿæˆçš„ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”Ÿæˆtoken</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId æŠŠuserIdï¼ŒversionCodeç¼–ç åˆ°tokenè´Ÿè½½ä¸­ï¼ŒåŒæ—¶æŠŠåˆ·æ–°tokenæ“ä½œçš„è¿‡æœŸæ—¶é—´ä¹Ÿç¼–ç åˆ°è´Ÿè½½ä¸­</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> token</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">generateToken</span><span class="params">(String userId, Integer versionCode)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//è¿‡æœŸæ—¶é—´</span></span><br><span class="line">        Date expire = Date.from(LocalDateTime.now().plusSeconds(jsonWebTokenProperties.getAccessTokenExpireTime()).atZone(ZoneId.systemDefault()).toInstant());</span><br><span class="line">        <span class="comment">//åˆ·æ–°æ—¶é—´</span></span><br><span class="line">        Date refresh = Date.from(LocalDateTime.now().plusSeconds(jsonWebTokenProperties.getRefreshTokenExpireTime()).atZone(ZoneId.systemDefault()).toInstant());</span><br><span class="line">        <span class="keyword">return</span> JWT.create()</span><br><span class="line">                .withClaim(JsonWebTokenConstant.TOKEN_USER_ID_FLAG, userId)</span><br><span class="line">                .withClaim(JsonWebTokenConstant.REFRESH_TOKEN_FLAG, refresh)</span><br><span class="line">                .withClaim(JsonWebTokenConstant.TOKEN_VERSION_ID_FLAG, versionCode)</span><br><span class="line">                .withIssuer(JsonWebTokenConstant.ISSUER)</span><br><span class="line">                .withExpiresAt(expire)</span><br><span class="line">                .sign(algorithm);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p><p>jsonWebTokenPropertieså’ŒJsonWebTokenConstantæ˜¯è‡ªå®šä¹‰çš„æšä¸¾æˆ–propertiesã€‚<br><strong>æ–¹æ¡ˆï¼š<br>1ã€ç»™Tokenè®¾è®¡ä¸€ä¸ªè¿‡æœŸæ—¶é—´å’Œåˆ·æ–°æ—¶é—´</strong></p><ul><li>è¿‡æœŸæ—¶é—´ï¼šé€šè¿‡è‡ªå¸¦çš„withExpiresAt()æ–¹æ³•è®¾ç½®ï¼Œè¯·æ±‚æºå¸¦tokenè®¿é—®ï¼ŒéªŒè¯tokençš„æ—¶å€™å½“å‰æ—¶é—´å·²ç»è¶…è¿‡äº†è¿™ä¸ªè¿‡æœŸæ—¶é—´ï¼Œé‚£ä¹ˆéªŒè¯å°±ä¸ä¼šé€šè¿‡ï¼Œä¼šç›´æ¥æŠ¥é”™ï¼Œè¿™ä¸ªæ—¶å€™å°±è¯¥æç¤ºç”¨æˆ·å»ç™»å½•ã€‚</li><li>åˆ·æ–°æ—¶é—´ï¼šåˆ·æ–°æ—¶é—´åªèƒ½æ”¾åœ¨tokençš„è·è½½é‡Œé¢äº†ï¼ŒéªŒè¯tokençš„æ—¶å€™ï¼Œå½“å‰æ—¶é—´å·²ç»è¶…è¿‡äº†è¿™ä¸ªåˆ·æ–°æ—¶é—´ï¼Œä½†æ˜¯åˆä¸è¶…è¿‡è¿‡æœŸæ—¶é—´ï¼Œè¿™ä¸ªæ—¶å€™å°±åº”è¯¥é‡æ–°ç”Ÿæˆä¸€ä¸ªtokenï¼Œè¿™ä¸ªæ–°tokenå°±ä¼šæœ‰æ–°çš„è¿‡æœŸæ—¶é—´ï¼Œåˆ·æ–°æ—¶é—´ï¼Œæ”¾åœ¨å“åº”å¤´è¿”å›ç»™ç”¨æˆ·ï¼Œå‰ç«¯æ‹¿åˆ°æ–°tokenå°±æ›¿æ¢æ‰åŸæ¥çš„tokenã€‚è¿™æ ·å°±å¯ä»¥å®ç°ç”¨æˆ·çš„æ— è¡”æ¥è®¿é—®ã€‚(è¿™ä¸ªåœ°æ–¹ä¹Ÿä¼šæœ‰ä¸ªå¹¶å‘é—®é¢˜ï¼Œåé¢ä¼šè¯´åˆ°)ã€‚å¦‚æœä¸è®¾è®¡åˆ·æ–°æ—¶é—´ï¼Œåªæœ‰è¿‡æœŸæ—¶é—´ï¼Œå‡å¦‚15å¤©è¿‡æœŸï¼Œè¿™15å¤©å†…ç”¨æˆ·éƒ½åœ¨è®¿é—®ï¼Œä½†æ˜¯15å¤©è¿‡å»äº†ï¼Œå•ªï¼ŒéªŒè¯ä¸é€šè¿‡ï¼Œè®©ç”¨æˆ·å»ç™»å½•ï¼Œè¿™æ ·ç”¨æˆ·ä½“éªŒä¸å¥½ï¼Œæˆ‘ä»¬å°±åœ¨ç”¨æˆ·ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹åˆ·æ–°äº†å®ƒçš„Tokenã€‚å‡å¦‚ç”¨æˆ·15å¤©éƒ½æ²¡æœ‰è®¿é—®è¿‡ï¼ŒéªŒè¯ä¸é€šè¿‡ï¼Œæç¤ºå»ç™»é™†ï¼Œè¿™ä¸ªå¾ˆæ­£å¸¸ã€‚</li></ul><p><strong>2ã€Tokençš„è·è½½</strong><br>å¯ä»¥é€šè¿‡withClaim()æ–¹æ³•åœ¨tokené‡Œé¢æ”¾å…¥ä½ éœ€è¦çš„ä¿¡æ¯ã€‚æˆ‘è¿™é‡Œæ”¾å…¥äº†åˆ·æ–°æ—¶é—´ï¼ŒuserIdï¼Œè¿˜æœ‰ä¸€ä¸ª<strong>versionCode</strong>ã€‚<br>éªŒè¯tokençš„æ—¶å€™å¯ä»¥è¿™æ ·æ‹¿åˆ°ä½ æ”¾è¿›å»çš„ä¿¡æ¯ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DecodedJWT decodedJWT = jwtVerifier.verify(token);</span><br><span class="line">   Map&lt;String, Claim&gt; claimMap = decodedJWT.getClaims();</span><br><span class="line">   Date refresh = claimMap.get(JsonWebTokenConstant.REFRESH_TOKEN_FLAG).asDate();</span><br></pre></td></tr></table></figure></p><p><strong>3ã€Tokençš„ç‰ˆæœ¬-å…³é”®ç‚¹ï¼ï¼ï¼</strong><br>è¿™é‡Œè®¾è®¡çš„ç‰ˆæœ¬å°±æ˜¯è·è½½é‡Œé¢çš„ <strong>versionCode</strong>ã€‚<br>è¿™ä¸ªç‰ˆæœ¬å·ç”¨æ¥åšä»€ä¹ˆï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">versionCodeè®¾è®¡çš„é»˜è®¤å€¼æ˜¯ï¼š2147500033 </span><br><span class="line">æŠŠå®ƒè½¬æ¢æˆäºŒè¿›åˆ¶çœ‹çœ‹ï¼š1000 00000000000001 00000000000001(32ä½)</span><br><span class="line">ä»å·¦å¾€å³çœ‹ï¼Œå·¦è¾¹çš„14ä½ï¼š00000000000001 ç”¨æ¥å­˜æ”¾tokenç‰ˆæœ¬å·ï¼Œæ¯ç”Ÿæˆä¸€æ¬¡tokenå°±+1ï¼Œè¯´æ˜æ¯æ¬¡åˆ·æ–°tokençš„æ—¶å€™ç”Ÿæˆtokenï¼Œæ¯æ¬¡ç™»å½•çš„æ—¶å€™ç”Ÿæˆtokenè¿™ä¸ªç‰ˆæœ¬éƒ½è¦+1</span><br><span class="line">å†çœ‹ï¼Œä¸­é—´çš„14ä½ï¼š00000000000001  ç”¨æ¥å­˜æ”¾ç™»å½•ç‰ˆæœ¬å·ï¼Œæ¯ç™»å½•ä¸€æ¬¡æ‰+1</span><br><span class="line">æœ€åå‰©ä¸‹é«˜ä½çš„4ä½ï¼š1000 æš‚æ—¶å†—ä½™å‡ºæ¥çš„</span><br></pre></td></tr></table></figure><p>æ¯æ¬¡ç™»å½•çš„æ—¶å€™å¾ˆç®€å•ï¼Œä»æ•°æ®åº“å–è¯¥ç”¨æˆ·çš„versionCode(æ•°æ®åº“å­˜çš„Integerç±»å‹)ï¼Œå…ˆæŠŠversionCodeè½¬æ¢æˆäºŒè¿›åˆ¶ï¼Œç„¶åæˆªå–å‡ºç™»å½•ç‰ˆæœ¬ï¼Œtokenç‰ˆæœ¬åˆ†åˆ«+1ï¼Œç„¶åå†æ‹¼æ¥æˆäºŒè¿›åˆ¶å­—ç¬¦ä¸²ï¼Œå†è½¬æ¢æˆIntegerï¼Œæ”¾åœ¨Tokenè·è½½ï¼Œæ›´æ–°æ•°æ®åº“ã€‚</p><h4 id="æ¯æ¬¡éªŒè¯tokençš„æ—¶å€™ï¼Œå¦‚æœæ˜¯éœ€è¦åˆ·æ–°tokençš„æƒ…å†µï¼Œéƒ½éœ€è¦éªŒè¯ç‰ˆæœ¬å·ï¼Œä¸ºäº†é˜²æ­¢Tokenæ³„éœ²æ¶æ„è®¿é—®"><a href="#æ¯æ¬¡éªŒè¯tokençš„æ—¶å€™ï¼Œå¦‚æœæ˜¯éœ€è¦åˆ·æ–°tokençš„æƒ…å†µï¼Œéƒ½éœ€è¦éªŒè¯ç‰ˆæœ¬å·ï¼Œä¸ºäº†é˜²æ­¢Tokenæ³„éœ²æ¶æ„è®¿é—®" class="headerlink" title="æ¯æ¬¡éªŒè¯tokençš„æ—¶å€™ï¼Œå¦‚æœæ˜¯éœ€è¦åˆ·æ–°tokençš„æƒ…å†µï¼Œéƒ½éœ€è¦éªŒè¯ç‰ˆæœ¬å·ï¼Œä¸ºäº†é˜²æ­¢Tokenæ³„éœ²æ¶æ„è®¿é—®"></a>æ¯æ¬¡éªŒè¯tokençš„æ—¶å€™ï¼Œå¦‚æœæ˜¯éœ€è¦åˆ·æ–°tokençš„æƒ…å†µï¼Œéƒ½éœ€è¦éªŒè¯ç‰ˆæœ¬å·ï¼Œä¸ºäº†é˜²æ­¢Tokenæ³„éœ²æ¶æ„è®¿é—®</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">æ‹¿Tokenæºå¸¦çš„versionCodeä¸æ•°æ®åº“çš„versionCodeæ¯”è¾ƒ</span><br><span class="line">è‹¥ç™»å½•ç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œæˆ–Tokenç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œéƒ½æç¤ºå»ç™»å½•</span><br><span class="line">è‹¥ä¸¤ä¸ªç‰ˆæœ¬éƒ½ä¸€è‡´ï¼Œæ‰ç»§ç»­æ‰§è¡Œåˆ·æ–°tokençš„é€»è¾‘</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¼šæœ‰ä¸ªå¹¶å‘é—®é¢˜ï¼ŒAppæœ‰æ—¶å€™è¯·æ±‚æ˜¯å¥½å‡ ä¸ªä¸€èµ·åˆ°è¾¾çš„ï¼Œè¿™äº›è¯·æ±‚éƒ½æºå¸¦çš„åŒæ ·çš„tokenã€‚æœ‰å¯èƒ½ç¬¬ä¸€ä¸ªè¯·æ±‚æ›´æ–°äº†æ•°æ®çš„versionCodeï¼Œé‚£ä¹ˆä¹‹åçš„è¯·æ±‚è¿›æ¥éªŒè¯çš„æ—¶å€™å°±ä¼šéªŒè¯ä¸é€šè¿‡ï¼Œå› ä¸ºéªŒè¯tokenæ˜¯æ”¾åœ¨æ‹¦æˆªå™¨é‡Œé¢çš„ï¼Œå‡ ä¹æ‰€æœ‰è¯·æ±‚éƒ½è¦èµ°è¿™é‡Œï¼ŒåŠ é”ä¸ç°å®ã€‚<br>è¿™é‡Œè¿™æ ·è§£å†³çš„ï¼šåˆ·æ–°tokençš„æ—¶å€™å¦‚æœç”Ÿæˆäº†tokenï¼Œredisé‡Œé¢ä¹Ÿä¼šç¼“å­˜30ç§’è¿™ä¸ªtokenï¼Œæ•°æ®åº“å¢åŠ äº†ä¸€ä¸ªæœ€ååˆ·æ–°tokenæ—¶é—´å­—æ®µï¼ŒéªŒè¯tokençš„æ—¶å€™è‹¥åœ¨è¿™ä¸ª30ç§’å†…ï¼Œè¯´æ˜30ç§’å†…æœ‰è¯·æ±‚åˆ·æ–°è¿‡tokenï¼Œå¹¶ä¸”æºå¸¦äº†æ–°tokenè¿”å›ã€‚ç›´æ¥ç•¥è¿‡éªŒè¯ã€‚(è¿™é‡Œä¼šæœ‰ç‚¹ç»•ï¼Œæ…¢æ…¢æ°æ‰è¡Œ)ï¼Œä¸Šéƒ¨åˆ†ä»£ç ï¼š</p><h5 id="BasedInterceptor-preHandle-èŠ‚é€‰ï¼š"><a href="#BasedInterceptor-preHandle-èŠ‚é€‰ï¼š" class="headerlink" title="BasedInterceptor preHandle()èŠ‚é€‰ï¼š"></a>BasedInterceptor preHandle()èŠ‚é€‰ï¼š</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"><span class="comment">//éªŒè¯Token</span></span><br><span class="line">    JsonWebTokenVerifyStatus jsonWebTokenVerifyStatus = jsonWebTokenUtils.verification(request);</span><br><span class="line">    <span class="keyword">if</span> (jsonWebTokenVerifyStatus.equals(JsonWebTokenVerifyStatus.LOGIN)) &#123;</span><br><span class="line">        logger.debug(<span class="string">"uid:&#123;&#125;--------------------------------------------,JsonWebTokenVerifyStatus.LOGIN"</span>, headerUserId);</span><br><span class="line">        <span class="comment">//ç™»é™†è¿‡æœŸæˆ–ç™»å½•å¼‚å¸¸ï¼Œéœ€è¦é‡æ–°ç™»å½•!</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BusinessException(BusinessErrorCode.LOGIN_EXPIRE);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (jsonWebTokenVerifyStatus.equals(JsonWebTokenVerifyStatus.LOGIN_OTHER)) &#123;</span><br><span class="line">        logger.debug(<span class="string">"uid:&#123;&#125;--------------------------------------------,JsonWebTokenVerifyStatus.LOGIN_OTHER"</span>, headerUserId);</span><br><span class="line">        <span class="comment">//è¯¥è´¦å·åœ¨åˆ«çš„è®¾å¤‡ç™»å½•ï¼  æç¤ºä¿¡æ¯</span></span><br><span class="line">        String message = userBaseGrpcService.getLoginRecord(headerUserId, jsonWebTokenUtils.getVersionCodeFromHttpServletRequest(request).toString(), request.getIntHeader(RequestConstans.CLIENT_OS), <span class="number">2</span>).getData().toString();</span><br><span class="line">        <span class="keyword">this</span>.loginOtherMessagePrompt(BusinessErrorCode.LOGIN_OTHER, response, message);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (jsonWebTokenVerifyStatus.equals(JsonWebTokenVerifyStatus.SUCCESS)) &#123;</span><br><span class="line">        <span class="comment">//éªŒè¯æˆåŠŸæ”¾è¡Œ</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (jsonWebTokenVerifyStatus.equals(JsonWebTokenVerifyStatus.CREATE_NEW)) &#123;</span><br><span class="line">        String userId = CurrentUserSession.getUserId().toString();</span><br><span class="line">        <span class="comment">//éœ€è¦åˆ·æ–°token</span></span><br><span class="line">        String existToken = jedisCommands.get(userId + JsonWebTokenConstant.REDIS_TOKEN_SUFFIX);</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(existToken)) &#123;</span><br><span class="line">            logger.debug(<span class="string">"uid:&#123;&#125;--------------------------------------------,JsonWebTokenVerifyStatus.CREATE_NEW"</span>, headerUserId);</span><br><span class="line">            <span class="comment">//å¦‚æœrediså·²å­˜åœ¨æœ€è¿‘åˆšåˆšåˆ·æ–°ç”Ÿæˆçš„token</span></span><br><span class="line">            response.setHeader(JsonWebTokenConstant.RESPONSE_HEADER_USER_TOKEN_FLAG, existToken);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//éœ€è¦é‡æ–°ç”Ÿæˆtoken ç»§ç»­è¯·æ±‚æ•°æ®  æŠŠæ–°tokenæ”¾åœ¨header</span></span><br><span class="line">            logger.debug(<span class="string">"uid:&#123;&#125;--------------------------------------------,JsonWebTokenVerifyStatus.CREATE_NEW,refreshGenerateTokenByRequestCode()"</span>, headerUserId);</span><br><span class="line">            String allNewToken = jsonWebTokenUtils.refreshGenerateTokenByRequestCode(userId, request);</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isNotEmpty(allNewToken)) &#123;</span><br><span class="line">                response.setHeader(JsonWebTokenConstant.RESPONSE_HEADER_USER_TOKEN_FLAG, allNewToken);</span><br><span class="line">                jedisCommands.setex(userId + JsonWebTokenConstant.REDIS_TOKEN_SUFFIX, JsonWebTokenConstant.REDIS_TOKEN_EXPIRE, allNewToken);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯jsonWebTokenUtils.verification(request).getCode()æ–¹æ³•</p><h4 id="JsonWebTokenUtilsèŠ‚é€‰"><a href="#JsonWebTokenUtilsèŠ‚é€‰" class="headerlink" title="JsonWebTokenUtilsèŠ‚é€‰"></a>JsonWebTokenUtilsèŠ‚é€‰</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * éªŒè¯tokenï¼Œè¿”å›çŠ¶æ€</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> request request</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> JsonWebTokenVerifyStatus</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> JsonWebTokenVerifyStatus <span class="title">verification</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">    String token = <span class="keyword">this</span>.getToken(request);</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isEmpty(token)) &#123;</span><br><span class="line">        logger.info(<span class="string">"Token is emptyï¼To loginï¼"</span>);</span><br><span class="line">        <span class="keyword">return</span> JsonWebTokenVerifyStatus.LOGIN;</span><br><span class="line">    &#125;</span><br><span class="line">    logger.debug(<span class="string">"uid:&#123;&#125;,token:&#123;&#125;"</span>, request.getHeader(RequestConstans.USER_ID), token);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        DecodedJWT decodedJWT = jwtVerifier.verify(token);</span><br><span class="line">        Map&lt;String, Claim&gt; claimMap = decodedJWT.getClaims();</span><br><span class="line">        Date refresh = claimMap.get(JsonWebTokenConstant.REFRESH_TOKEN_FLAG).asDate();</span><br><span class="line">        String userId = claimMap.get(JsonWebTokenConstant.TOKEN_USER_ID_FLAG).asString();</span><br><span class="line">        <span class="comment">//ä¿å­˜å½“å‰userId</span></span><br><span class="line">        CurrentUserSession.setUserId(Long.valueOf(userId));</span><br><span class="line">        <span class="keyword">if</span> (!userId.equals(request.getHeader(RequestConstans.USER_ID))) &#123;</span><br><span class="line">            <span class="comment">//éªŒè¯tokenä¸­çš„uidæ˜¯å¦ä¸headerä¸­çš„uidä¸€è‡´</span></span><br><span class="line">            logger.error(<span class="string">"header in uid and user_token in uid differ error &#123;&#125; "</span>, userId);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BusinessException(BusinessErrorCode.VOICE_CALL_PARAM_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (refresh.getTime() &lt; System.currentTimeMillis()) &#123;</span><br><span class="line">            <span class="comment">//åˆ·æ–° token</span></span><br><span class="line">            Integer versionCode = claimMap.get(JsonWebTokenConstant.TOKEN_VERSION_ID_FLAG).asInt();</span><br><span class="line">            <span class="keyword">if</span> (versionCode == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//å…¼å®¹è€token</span></span><br><span class="line">                <span class="keyword">return</span> JsonWebTokenVerifyStatus.CREATE_NEW;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//éªŒè¯tokenä¸­çš„ç‰ˆæœ¬å·æ˜¯å¦ä¸æ•°æ®åº“ä¸­çš„æ˜¯å¦ä¸€è‡´ï¼Œä¸ä¸€è‡´çš„è¯è½¬ç™»å½•</span></span><br><span class="line">            LoginTokenVersionCompareEnum result = <span class="keyword">this</span>.checkVersion(versionCode, request, Long.valueOf(userId));</span><br><span class="line">             <span class="keyword">if</span> (result.equals(LoginTokenVersionCompareEnum.TOKEN_DIFFERENCE)) &#123;</span><br><span class="line">                <span class="comment">//tokenVersionç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œæç¤ºå»ç™»å½•</span></span><br><span class="line">                <span class="keyword">return</span> JsonWebTokenVerifyStatus.LOGIN;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (result.equals(LoginTokenVersionCompareEnum.IN_CONSISTENT)) &#123;</span><br><span class="line">                <span class="comment">//loginVersionå’ŒtokenVersionä¸ä¸€è‡´ï¼Œåœ¨åˆ«å¤„ç™»å½•è¿‡</span></span><br><span class="line">                <span class="keyword">return</span> JsonWebTokenVerifyStatus.LOGIN_OTHER;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (result.equals(LoginTokenVersionCompareEnum.LATEST_REFRESH)) &#123;</span><br><span class="line">                <span class="comment">//è¿‘æœŸ(30ç§’å†…)åˆ·æ–°è¿‡tokenï¼Œ</span></span><br><span class="line">                <span class="keyword">return</span> JsonWebTokenVerifyStatus.SUCCESS;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//loginVersionå’ŒtokenVersionéƒ½ä¸€è‡´ï¼Œåˆ·æ–°token</span></span><br><span class="line">                logger.info(JsonWebTokenVerifyStatus.CREATE_NEW.getMessage());</span><br><span class="line">                <span class="keyword">return</span> JsonWebTokenVerifyStatus.CREATE_NEW;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> JsonWebTokenVerifyStatus.SUCCESS;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (BusinessException b) &#123;</span><br><span class="line">        <span class="keyword">throw</span> b;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (JWTVerificationException JWTVerificationException) &#123;</span><br><span class="line">   <span class="comment">//tokenéªŒè¯å¤±è´¥ï¼Œtokenè¿‡æœŸæˆ–è€…æ˜¯å‡token</span></span><br><span class="line">        logger.info(JsonWebTokenVerifyStatus.LOGIN.getMessage());</span><br><span class="line">        <span class="keyword">return</span> JsonWebTokenVerifyStatus.LOGIN;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯this.checkVersion(versionCode, request, Long.valueOf(userId)).getCode();æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ ¡éªŒç‰ˆæœ¬å·</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> requestVersionCode è¯·æ±‚tokené‡Œæºå¸¦çš„ç‰ˆæœ¬å·</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> request            request</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> userId             userId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> Boolean</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> LoginTokenVersionCompareEnum <span class="title">checkVersion</span><span class="params">(Integer requestVersionCode, HttpServletRequest request, Long userId)</span> </span>&#123;</span><br><span class="line">    SimpleDateFormat simpleDateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd  HH:mm:ss"</span>);</span><br><span class="line">    <span class="keyword">int</span> loginAndTokenLength = jsonWebTokenProperties.getLoginTokenVersionCodeTokenLength();</span><br><span class="line">    ImUserBase imUserBase = imUserBaseMapper.selectByPrimaryKey(userId);</span><br><span class="line">    PlatformEnum platformEnum = <span class="keyword">this</span>.getPlatformFromRequest(request);</span><br><span class="line">    Date date;</span><br><span class="line">    Integer dbVersionCode;</span><br><span class="line">    <span class="keyword">if</span> (platformEnum.equals(PlatformEnum.ANDROID) || platformEnum.equals(PlatformEnum.IOS)) &#123;</span><br><span class="line">        dbVersionCode = imUserBase.getAppTokenVersion();</span><br><span class="line">        date = imUserBase.getAppTokenRefreshTime();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        dbVersionCode = imUserBase.getWebTokenVersion();</span><br><span class="line">        date = imUserBase.getWebTokenRefreshTime();</span><br><span class="line">    &#125;</span><br><span class="line">    String requestVersionCodeBinary = BitUtils.decimalToBinary(requestVersionCode);</span><br><span class="line">    String dbVersionCodeBinary = BitUtils.decimalToBinary(dbVersionCode);</span><br><span class="line">    Boolean tokenCompareResult = requestVersionCodeBinary.substring(requestVersionCodeBinary.length() - loginAndTokenLength)</span><br><span class="line">            .equals(dbVersionCodeBinary.substring(dbVersionCodeBinary.length() - loginAndTokenLength));</span><br><span class="line">    Boolean loginCompareResult = requestVersionCodeBinary.substring(requestVersionCodeBinary.length() - <span class="number">2</span> * loginAndTokenLength, requestVersionCodeBinary.length() - loginAndTokenLength)</span><br><span class="line">            .equals(dbVersionCodeBinary.substring(dbVersionCodeBinary.length() - <span class="number">2</span> * loginAndTokenLength, dbVersionCodeBinary.length() - loginAndTokenLength));</span><br><span class="line">    <span class="comment">//tokenç‰ˆæœ¬ä»…ç›¸å·®1çš„æƒ…å†µ  è¯´æ˜è¿‘æœŸæœ‰è¯·æ±‚åˆ·æ–°è¿‡token</span></span><br><span class="line">    Integer addResultCode = <span class="keyword">this</span>.increaseVersion(requestVersionCode, JsonWebTokenConstant.TOKEN_VERSION_TAG);</span><br><span class="line">    logger.debug(<span class="string">"requestVersionCode:&#123;&#125;,addResultCode:&#123;&#125;,dbVersionCode:&#123;&#125;"</span>, requestVersionCode, addResultCode, dbVersionCode);</span><br><span class="line">    <span class="keyword">boolean</span> tokenVersionDifferOne = addResultCode.equals(dbVersionCode);</span><br><span class="line">    Long intervalTime = System.currentTimeMillis() - date.getTime();</span><br><span class="line">    logger.debug(<span class="string">"loginCompareResult:&#123;&#125;,tokenCompareResult:&#123;&#125;,tokenVersionDifferOne:&#123;&#125;,intervalTime:&#123;&#125;,latestRefresh:&#123;&#125;,SystemTime:&#123;&#125;,dbTime:&#123;&#125;"</span>,</span><br><span class="line">            loginCompareResult, tokenCompareResult, tokenVersionDifferOne, intervalTime, intervalTime &lt;= JsonWebTokenConstant.LATEST_REFRESH_TIME, simpleDateFormat.format(<span class="keyword">new</span> Date()), simpleDateFormat.format(date));</span><br><span class="line">    <span class="keyword">if</span> (loginCompareResult &amp;&amp; tokenCompareResult) &#123;</span><br><span class="line">        logger.debug(<span class="string">"uid:&#123;&#125;--------------------------------------------,LoginTokenVersionCompareEnum.CONSISTENT"</span>, userId);</span><br><span class="line">        <span class="comment">//éƒ½ä¸€è‡´</span></span><br><span class="line">        <span class="keyword">return</span> LoginTokenVersionCompareEnum.CONSISTENT;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (loginCompareResult &amp;&amp; tokenVersionDifferOne &amp;&amp; intervalTime &lt;= JsonWebTokenConstant.LATEST_REFRESH_TIME) &#123;</span><br><span class="line">        logger.debug(<span class="string">"uid:&#123;&#125;--------------------------------------------,LoginTokenVersionCompareEnum.LATEST_REFRESH"</span>, userId);</span><br><span class="line">        <span class="comment">//ç‰ˆæœ¬ç›¸å·®1ä¸”åŒæ—¶æœŸæœ‰è¯·æ±‚åˆ·æ–°è¿‡token  30ç§’å†…</span></span><br><span class="line">        <span class="keyword">return</span> LoginTokenVersionCompareEnum.LATEST_REFRESH;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (loginCompareResult) &#123;</span><br><span class="line">        logger.debug(<span class="string">"uid:&#123;&#125;--------------------------------------------,LoginTokenVersionCompareEnum.TOKEN_DIFFERENCE"</span>, userId);</span><br><span class="line">        <span class="comment">//loginç‰ˆæœ¬ä¸€è‡´ï¼Œtokenç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œæç¤ºå»ç™»å½•</span></span><br><span class="line">        <span class="keyword">return</span> LoginTokenVersionCompareEnum.TOKEN_DIFFERENCE;</span><br><span class="line">    &#125;</span><br><span class="line">    logger.debug(<span class="string">"uid:&#123;&#125;--------------------------------------------,LoginTokenVersionCompareEnum.IN_CONSISTENT"</span>, userId);</span><br><span class="line">    <span class="comment">//éƒ½ä¸ä¸€è‡´ï¼Œè¯´æ˜è¯¥è´¦å·åœ¨å…¶ä»–è®¾å¤‡ç™»å½•è¿‡ï¼Œæç¤ºå»ç™»å½•</span></span><br><span class="line">    <span class="keyword">return</span> LoginTokenVersionCompareEnum.IN_CONSISTENT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åªèŠ‚é€‰äº†éƒ¨åˆ†ä»£ç ï¼Œè®¾è®¡æ–¹æ¡ˆä»…ä¾›å‚è€ƒï¼Œä¸åŒä¸šåŠ¡åœºæ™¯è®¾è®¡ä¸ä¸€æ ·ã€‚</p><hr><p>æˆ‘çš„:</p><ul><li>ğŸ€ ğŸ€ ğŸ€&gt;&gt;&gt;&gt;&gt;&gt;&gt;<a href="https://blog.csdn.net/axela30w" target="_blank" rel="noopener">CSDN</a>&lt;&lt;&lt;&lt;&lt;&lt;&lt;ğŸ€ ğŸ€ ğŸ€</li><li>ğŸ€ ğŸ€ ğŸ€&gt;&gt;&gt;&gt;&gt;&gt;&gt;<a href="https://github.com/MistraR" target="_blank" rel="noopener">GitHub</a>&lt;&lt;&lt;&lt;&lt;&lt;&lt;ğŸ€ ğŸ€ ğŸ€</li><li>ğŸ€ ğŸ€ ğŸ€&gt;&gt;&gt;&gt;&gt;&gt;&gt;<a href="http://mistra.wang/">ä¸ªäººåšå®¢</a>&lt;&lt;&lt;&lt;&lt;&lt;&lt;ğŸ€ ğŸ€ ğŸ€</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;Json-web-tokens-ï¼šå®˜ç½‘&quot;&gt;&lt;a href=&quot;#Json-web-tokens-ï¼šå®˜ç½‘&quot; class=&quot;headerlink&quot; title=&quot;Json web tokens ï¼šå®˜ç½‘&quot;&gt;&lt;/a&gt;Json web tokens ï¼š&lt;a href=&quot;htt
      
    
    </summary>
    
      <category term="è®¾è®¡æ–¹æ¡ˆ" scheme="http://mistra.wang/categories/%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/"/>
    
    
      <category term="JsonWebToken" scheme="http://mistra.wang/tags/JsonWebToken/"/>
    
  </entry>
  
</feed>
